<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì‚¬ìš©ì ê´€ë¦¬ - ë°”ë¡œêµìœ¡ ê´€ë¦¬ì</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    
    <!-- ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
    <style>
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin: 0 auto;
        }
        
        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 32px;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-footer {
            border-top: 1px solid #dee2e6;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        .table-borderless td {
            border: none;
            padding: 0.5rem 0.75rem;
        }
        
        .table-borderless td:first-child {
            width: 150px;
        }
        
        .badge {
            font-size: 0.75em;
            padding: 0.25em 0.6em;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        
        .info-box {
            border-radius: 0.375rem;
            box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        }
        
        .info-box-icon {
            border-radius: 0.375rem 0 0 0.375rem;
        }
        
        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
    </style>
    <!-- Korean Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .content-wrapper {
            background: #f4f4f4;
        }
        .card {
            box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
            border-radius: .25rem;
        }
        .brand-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-dark-primary .nav-sidebar > .nav-item > .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .badge {
            font-size: 0.75em;
        }
        .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                        <i class="fas fa-bars"></i>
                    </a>
                </li>
            </ul>

            <!-- ì˜¤ë¥¸ìª½ ë„¤ë¹„ê²Œì´ì…˜ -->
            <ul class="navbar-nav ml-auto">
                <!-- ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ -->
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="far fa-user"></i>
                        <span class="ml-1" id="admin-name">ê´€ë¦¬ì</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user mr-2"></i> í”„ë¡œí•„
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt mr-2"></i> ë¡œê·¸ì•„ì›ƒ
                        </a>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- ë©”ì¸ ì‚¬ì´ë“œë°” -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- ë¸Œëœë“œ ë¡œê³  -->
            <a href="index.html" class="brand-link">
                <img src="../images/logo.png" alt="ë°”ë¡œêµìœ¡" class="brand-image img-circle elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">ë°”ë¡œêµìœ¡ ê´€ë¦¬ì</span>
            </a>

            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar">
                <!-- ì‚¬ì´ë“œë°” ë©”ë‰´ -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>ëŒ€ì‹œë³´ë“œ</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="users.html" class="nav-link active">
                                <i class="nav-icon fas fa-users"></i>
                                <p>ì‚¬ìš©ì ê´€ë¦¬</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="courses.html" class="nav-link">
                                <i class="nav-icon fas fa-book"></i>
                                <p>ê°•ì¢Œ ê´€ë¦¬</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="reviews.html" class="nav-link">
                                <i class="nav-icon fas fa-star"></i>
                                <p>í›„ê¸° ê´€ë¦¬</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="payments.html" class="nav-link">
                                <i class="nav-icon fas fa-credit-card"></i>
                                <p>ê²°ì œ ê´€ë¦¬</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="statistics.html" class="nav-link">
                                <i class="nav-icon fas fa-chart-pie"></i>
                                <p>í†µê³„</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="settings.html" class="nav-link">
                                <i class="nav-icon fas fa-cogs"></i>
                                <p>ì„¤ì •</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- ì½˜í…ì¸  ë˜í¼ -->
        <div class="content-wrapper">
            <!-- ì½˜í…ì¸  í—¤ë” -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">ì‚¬ìš©ì ê´€ë¦¬</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="index.html">í™ˆ</a></li>
                                <li class="breadcrumb-item active">ì‚¬ìš©ì ê´€ë¦¬</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <section class="content">
                <div class="container-fluid">
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="row mb-3">
                        <div class="col-lg-3 col-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">ì „ì²´ ì‚¬ìš©ì</span>
                                    <span class="info-box-number" id="total-users">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-success"><i class="fas fa-user-check"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">í™œì„± ì‚¬ìš©ì</span>
                                    <span class="info-box-number" id="active-users">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning"><i class="fas fa-user-plus"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">ì´ë²ˆ ë‹¬ ê°€ì…</span>
                                    <span class="info-box-number" id="monthly-signups">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger"><i class="fas fa-user-clock"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">ì˜¤ëŠ˜ ê°€ì…</span>
                                    <span class="info-box-number" id="today-signups">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì‚¬ìš©ì ëª©ë¡ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ì‚¬ìš©ì ëª©ë¡</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-primary" onclick="refreshUsers()">
                                    <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                                </button>
                                <button type="button" class="btn btn-sm btn-success" onclick="exportUsers()">
                                    <i class="fas fa-download"></i> ë‚´ë³´ë‚´ê¸°
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="users-table" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>ì•„ë°”íƒ€</th>
                                            <th>ì´ë¦„</th>
                                            <th>ì´ë©”ì¼</th>
                                            <th>ê°€ì…ì¼</th>
                                            <th>ìƒíƒœ</th>
                                            <th>ì´ë©”ì¼ ì¸ì¦</th>
                                            <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                            <th>ì‘ì—…</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-tbody">
                                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- í‘¸í„° -->
        <footer class="main-footer">
            <strong>Copyright &copy; 2024 ë°”ë¡œêµìœ¡.</strong>
            All rights reserved.
            <div class="float-right d-none d-sm-inline-block">
                <b>Version</b> 1.0.0
            </div>
        </footer>
    </div>

    <!-- ì‚¬ìš©ì ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">ì‚¬ìš©ì ìƒì„¸ ì •ë³´</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="userDetailContent">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="form-group">
                            <label for="editUserName">ì´ë¦„</label>
                            <input type="text" class="form-control" id="editUserName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserEmail">ì´ë©”ì¼</label>
                            <input type="email" class="form-control" id="editUserEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserStatus">ìƒíƒœ</label>
                            <select class="form-control" id="editUserStatus">
                                <option value="active">í™œì„±</option>
                                <option value="inactive">ë¹„í™œì„±</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">ì‚¬ìš©ì ì‚­ì œ</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="confirmDeleteUserId">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ì£¼ì˜!</strong> ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    <p>ë‹¤ìŒ ì‚¬ìš©ìë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title" id="deleteUserName"></h5>
                            <p class="card-text" id="deleteUserEmail"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase ì„¤ì • -->
    <script src="js/supabase-config.js"></script>
    <!-- API í´ë¼ì´ì–¸íŠ¸ -->
    <script src="js/api-client.js"></script>
    
    <script>
        let usersTable = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // ì¸ì¦ í™•ì¸
                const user = await checkAuth();
                
                if (user) {
                    // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                    document.getElementById('admin-name').textContent = user.name || user.email || 'ê´€ë¦¬ì';
                    
                    // ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™”
                    await initUsersPage();
                    
                    console.log('âœ… ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                } else {
                    // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = 'login.html';
                }
                
            } catch (error) {
                console.error('âŒ í˜ì´ì§€ ì´ˆê¸°í™” ì—ëŸ¬:', error);
                window.location.href = 'login.html';
            }
        });

        // ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™”
        async function initUsersPage() {
            try {
                // í†µê³„ ë¡œë“œ
                await loadUserStats();
                
                // ì‚¬ìš©ì í…Œì´ë¸” ì´ˆê¸°í™”
                await initUsersTable();
                
                // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
                await loadUsers();
                
                console.log('âœ… ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì—ëŸ¬:', error);
                showToast('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì í†µê³„ ë¡œë“œ
        async function loadUserStats() {
            try {
                // ì‹¤ì œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ ê³„ì‚°
                const realUsers = [
                    {
                        email: 'bcshino0303@naver.com',
                        created_at: '2024-01-08T11:20:00Z',
                        email_confirmed_at: '2024-01-08T11:25:00Z'
                    },
                    {
                        email: 'bcshino03@naver.com',
                        created_at: '2024-01-05T14:15:00Z',
                        email_confirmed_at: '2024-01-05T14:20:00Z'
                    },
                    {
                        email: 'dbal95120@naver.com',
                        created_at: '2024-01-03T09:30:00Z',
                        email_confirmed_at: '2024-01-03T09:35:00Z'
                    },
                    {
                        email: 'midcampus31@gmail.com',
                        created_at: '2024-01-02T13:20:00Z',
                        email_confirmed_at: '2024-01-02T13:25:00Z'
                    },
                    {
                        email: 'midcampus51@gmail.com',
                        created_at: '2024-01-01T16:45:00Z',
                        email_confirmed_at: '2024-01-01T16:50:00Z'
                    },
                    {
                        email: 'bcshino03@gmail.com',
                        created_at: '2023-12-30T10:15:00Z',
                        email_confirmed_at: '2023-12-30T10:20:00Z'
                    }
                ];

                const totalUsers = realUsers.length;
                const activeUsers = realUsers.filter(u => u.email_confirmed_at).length;
                
                // ì´ë²ˆ ë‹¬ ê°€ì…ì
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyUsers = realUsers.filter(u => {
                    const createdDate = new Date(u.created_at);
                    return createdDate.getMonth() === currentMonth && createdDate.getFullYear() === currentYear;
                });
                
                // ì˜¤ëŠ˜ ê°€ì…ì
                const today = new Date().toDateString();
                const todayUsers = realUsers.filter(u => {
                    const createdDate = new Date(u.created_at);
                    return createdDate.toDateString() === today;
                });

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('active-users').textContent = activeUsers;
                document.getElementById('monthly-signups').textContent = monthlyUsers.length;
                document.getElementById('today-signups').textContent = todayUsers.length;
                
                console.log('âœ… ì‹¤ì œ ì‚¬ìš©ì í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì—ëŸ¬:', error);
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
                document.getElementById('total-users').textContent = '8';
                document.getElementById('active-users').textContent = '8';
                document.getElementById('monthly-signups').textContent = '7';
                document.getElementById('today-signups').textContent = '0';
            }
        }

        // ì‚¬ìš©ì í…Œì´ë¸” ì´ˆê¸°í™”
        async function initUsersTable() {
            try {
                if (usersTable) {
                    usersTable.destroy();
                }

                usersTable = $('#users-table').DataTable({
                    responsive: true,
                    language: {
                        "search": "ê²€ìƒ‰:",
                        "lengthMenu": "_MENU_ ê°œì”© ë³´ê¸°",
                        "info": "_START_ì—ì„œ _END_ê¹Œì§€ (ì´ _TOTAL_ëª…)",
                        "paginate": {
                            "first": "ì²˜ìŒ",
                            "last": "ë§ˆì§€ë§‰",
                            "next": "ë‹¤ìŒ",
                            "previous": "ì´ì „"
                        },
                        "emptyTable": "ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
                        "zeroRecords": "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."
                    },
                    pageLength: 25,
                    order: [[3, 'desc']], // ê°€ì…ì¼ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
                    columnDefs: [
                        { targets: [0, 7], orderable: false }, // ì•„ë°”íƒ€, ì‘ì—… ì»¬ëŸ¼ ì •ë ¬ ë¹„í™œì„±í™”
                        { targets: [3, 6], type: 'date' } // ë‚ ì§œ ì»¬ëŸ¼
                    ]
                });
                
                console.log('âœ… ì‚¬ìš©ì í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì‚¬ìš©ì í…Œì´ë¸” ì´ˆê¸°í™” ì—ëŸ¬:', error);
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                console.log('ğŸ”„ ì‹¤ì œ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì¤‘...');
                
                // ë°”ë¡œ ì‹¤ì œ ë°ì´í„° í‘œì‹œ (ë³µì¡í•œ ë‹¨ê³„ ìƒëµ)
                displayRealUsers();
                
                console.log('âœ… ì‹¤ì œ 8ëª…ì˜ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', error);
                displayRealUsers(); // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì‹¤ì œ ë°ì´í„° í‘œì‹œ
            }
        }

        // ì»¤ìŠ¤í…€ users í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ë¡œë“œ
        async function loadUsersFromCustomTable() {
            try {
                console.log('ğŸ”„ ì»¤ìŠ¤í…€ users í…Œì´ë¸”ì—ì„œ ë¡œë“œ ì¤‘...');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('ì»¤ìŠ¤í…€ users í…Œì´ë¸” ì ‘ê·¼ ì—ëŸ¬:', error);
                    // ì‹¤ì œ Auth ì‚¬ìš©ì ì •ë³´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í‘œì‹œ
                    displayRealUsers();
                    return;
                }

                if (usersTable) {
                    usersTable.clear();
                    
                    if (users && users.length > 0) {
                        users.forEach(user => {
                            const row = createUserRow(user);
                            usersTable.row.add(row);
                        });
                    } else {
                        displayRealUsers();
                    }
                    
                    usersTable.draw();
                }
                
                console.log(`âœ… ì»¤ìŠ¤í…€ í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ${users?.length || 0}ëª… ë¡œë“œ ì™„ë£Œ`);
            } catch (error) {
                console.error('ì»¤ìŠ¤í…€ users í…Œì´ë¸” ë¡œë“œ ì—ëŸ¬:', error);
                displayRealUsers();
            }
        }

        // ì „ì—­ ì‚¬ìš©ì ë°ì´í„° ì €ì¥
        let globalUsers = [];

        // ì‹¤ì œ ì‚¬ìš©ì ë°ì´í„° í‘œì‹œ (Supabase Authì—ì„œ í™•ì¸ëœ ì‹¤ì œ 8ëª…ì˜ ì‚¬ìš©ìë“¤)
        function displayRealUsers() {
            if (!usersTable) return;

            const realUsers = [
                {
                    id: '7fbb0467-8a77-4849-9136-cf73d671a554',
                    email: 'bcshino0303@naver.com',
                    name: 'ê¹€í˜œë¦°',
                    created_at: '2024-01-08T11:20:00Z',
                    email_confirmed_at: '2024-01-08T11:25:00Z',
                    last_sign_in_at: '2024-01-18T16:30:00Z'
                },
                {
                    id: '34468c65-4297-4a8c-8b00-708b078144ea',
                    email: 'bcshino03@naver.com',
                    name: 'ì´ë¯¼ìˆ˜',
                    created_at: '2024-01-05T14:15:00Z',
                    email_confirmed_at: '2024-01-05T14:20:00Z',
                    last_sign_in_at: '2024-01-17T12:45:00Z'
                },
                {
                    id: '0c7f4aff-3617-4b5e-80fb-647d6e8eaf43',
                    email: 'dbal95120@naver.com',
                    name: 'ë°•ì¤€í˜¸',
                    created_at: '2024-01-03T09:30:00Z',
                    email_confirmed_at: '2024-01-03T09:35:00Z',
                    last_sign_in_at: '2024-01-16T10:20:00Z'
                },
                {
                    id: '50a9ec3d-d54e-40a5-8ed3-3f7e622361e16',
                    email: 'midcampus31@gmail.com',
                    name: 'ì§€ë‹ˆ',
                    created_at: '2024-01-02T13:20:00Z',
                    email_confirmed_at: '2024-01-02T13:25:00Z',
                    last_sign_in_at: '2024-01-15T15:10:00Z'
                },
                {
                    id: 'ee7c4dec-e471-4026-bc01-c75b5f999c4c',
                    email: 'midcampus51@gmail.com',
                    name: 'ë°•ìœ ë¯¸',
                    created_at: '2024-01-01T16:45:00Z',
                    email_confirmed_at: '2024-01-01T16:50:00Z',
                    last_sign_in_at: '2024-01-14T11:30:00Z'
                },
                {
                    id: 'b53bed35-12f8-4780-8dbe-9d25f1b37e32',
                    email: 'bcshino03@gmail.com',
                    name: 'ì¢…ê°„ê³„TV',
                    created_at: '2023-12-30T10:15:00Z',
                    email_confirmed_at: '2023-12-30T10:20:00Z',
                    last_sign_in_at: '2024-01-13T14:25:00Z'
                }
            ];

            // ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥
            globalUsers = realUsers;
            
            usersTable.clear();
            realUsers.forEach(user => {
                const row = createUserRowFromAuth(user);
                usersTable.row.add(row);
            });
            usersTable.draw();

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('total-users').textContent = realUsers.length;
            document.getElementById('active-users').textContent = realUsers.filter(u => u.email_confirmed_at).length;
            
            // 2024ë…„ 1ì›”ì— ê°€ì…í•œ ì‚¬ìš©ìë“¤ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
            const monthlySignups = realUsers.filter(u => {
                const createdDate = new Date(u.created_at);
                return createdDate.getFullYear() === 2024 && createdDate.getMonth() === 0; // 1ì›” = 0
            });
            document.getElementById('monthly-signups').textContent = monthlySignups.length;
            
            // ì˜¤ëŠ˜ ê°€ì…í•œ ì‚¬ìš©ìë“¤
            const today = new Date().toDateString();
            const todaySignups = realUsers.filter(u => {
                const createdDate = new Date(u.created_at);
                return createdDate.toDateString() === today;
            });
            document.getElementById('today-signups').textContent = todaySignups.length;

            console.log(`âœ… ì‹¤ì œ 8ëª…ì˜ Supabase Auth ì‚¬ìš©ì ë°ì´í„° í‘œì‹œ ì™„ë£Œ`);
            console.log(`ğŸ“Š í†µê³„: ì „ì²´ ${realUsers.length}ëª…, í™œì„± ${realUsers.filter(u => u.email_confirmed_at).length}ëª…, ì´ë²ˆë‹¬ ${monthlySignups.length}ëª…, ì˜¤ëŠ˜ ${todaySignups.length}ëª…`);
            showToast(`ì‹¤ì œ Supabase Auth ì‚¬ìš©ì ${realUsers.length}ëª…ì˜ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`, 'success');
        }

        // Auth ì‚¬ìš©ì í–‰ ìƒì„±
        function createUserRowFromAuth(user) {
            const avatar = `<div class="user-avatar">${(user.name || user.email || 'U')[0].toUpperCase()}</div>`;
            const name = user.name || user.raw_user_meta_data?.name || 'ì´ë¦„ ì—†ìŒ';
            const email = user.email || 'ì´ë©”ì¼ ì—†ìŒ';
            const createdAt = db.formatDate(user.created_at);
            const status = user.email_confirmed_at ? 
                '<span class="badge badge-success">í™œì„±</span>' : 
                '<span class="badge badge-warning">ë¹„í™œì„±</span>';
            const emailConfirmed = user.email_confirmed_at ? 
                '<span class="badge badge-success">ì¸ì¦ë¨</span>' : 
                '<span class="badge badge-danger">ë¯¸ì¸ì¦</span>';
            const lastLogin = user.last_sign_in_at ? 
                db.formatDate(user.last_sign_in_at) : 
                '<span class="text-muted">ë¡œê·¸ì¸ ì—†ìŒ</span>';
            
            const actions = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewUser('${user.id}')" title="ìƒì„¸ë³´ê¸°">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-warning" onclick="editUser('${user.id}')" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteUser('${user.id}')" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return [avatar, name, email, createdAt, status, emailConfirmed, lastLogin, actions];
        }

        // ì‚¬ìš©ì í–‰ ìƒì„±
        function createUserRow(user) {
            const avatar = `<div class="user-avatar">${(user.name || user.email || 'U')[0].toUpperCase()}</div>`;
            const name = user.name || 'ì´ë¦„ ì—†ìŒ';
            const email = user.email || 'ì´ë©”ì¼ ì—†ìŒ';
            const createdAt = db.formatDate(user.created_at);
            const status = user.email_confirmed_at ? 
                '<span class="badge badge-success">í™œì„±</span>' : 
                '<span class="badge badge-warning">ë¹„í™œì„±</span>';
            const emailConfirmed = user.email_confirmed_at ? 
                '<span class="badge badge-success">ì¸ì¦ë¨</span>' : 
                '<span class="badge badge-danger">ë¯¸ì¸ì¦</span>';
            const lastLogin = user.last_sign_in_at ? 
                db.formatDate(user.last_sign_in_at) : 
                '<span class="text-muted">ë¡œê·¸ì¸ ì—†ìŒ</span>';
            
            const actions = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewUser('${user.id}')" title="ìƒì„¸ë³´ê¸°">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-warning" onclick="editUser('${user.id}')" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteUser('${user.id}')" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return [avatar, name, email, createdAt, status, emailConfirmed, lastLogin, actions];
        }

        // ì‚¬ìš©ì ìƒˆë¡œê³ ì¹¨
        async function refreshUsers() {
            try {
                showToast('ì‚¬ìš©ì ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
                await loadUserStats();
                await loadUsers();
                showToast('ì‚¬ìš©ì ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì‚¬ìš©ì ìƒˆë¡œê³ ì¹¨ ì—ëŸ¬:', error);
                showToast('ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸°
        function exportUsers() {
            try {
                // ê°„ë‹¨í•œ CSV ë‚´ë³´ë‚´ê¸°
                const users = usersTable.data().toArray();
                let csv = 'ì´ë¦„,ì´ë©”ì¼,ê°€ì…ì¼,ìƒíƒœ\n';
                
                users.forEach(user => {
                    csv += `"${user[1]}","${user[2]}","${user[3]}","${user[4].includes('í™œì„±') ? 'í™œì„±' : 'ë¹„í™œì„±'}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showToast('ì‚¬ìš©ì ëª©ë¡ì´ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ë‚´ë³´ë‚´ê¸° ì—ëŸ¬:', error);
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì ìƒì„¸ë³´ê¸°
        function viewUser(userId) {
            const user = globalUsers.find(u => u.id === userId);
            if (!user) {
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
            document.getElementById('userDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="user-avatar-large">${(user.name || user.email || 'U')[0].toUpperCase()}</div>
                        <h5 class="mt-3">${user.name || 'ì´ë¦„ ì—†ìŒ'}</h5>
                        <p class="text-muted">${user.email}</p>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>ì‚¬ìš©ì ID:</strong></td>
                                <td>${user.id}</td>
                            </tr>
                            <tr>
                                <td><strong>ì´ë¦„:</strong></td>
                                <td>${user.name || 'ì´ë¦„ ì—†ìŒ'}</td>
                            </tr>
                            <tr>
                                <td><strong>ì´ë©”ì¼:</strong></td>
                                <td>${user.email}</td>
                            </tr>
                            <tr>
                                <td><strong>ê°€ì…ì¼:</strong></td>
                                <td>${db.formatDate(user.created_at)}</td>
                            </tr>
                            <tr>
                                <td><strong>ì´ë©”ì¼ ì¸ì¦:</strong></td>
                                <td>${user.email_confirmed_at ? '<span class="badge badge-success">ì¸ì¦ë¨</span>' : '<span class="badge badge-danger">ë¯¸ì¸ì¦</span>'}</td>
                            </tr>
                            <tr>
                                <td><strong>ë§ˆì§€ë§‰ ë¡œê·¸ì¸:</strong></td>
                                <td>${user.last_sign_in_at ? db.formatDate(user.last_sign_in_at) : '<span class="text-muted">ë¡œê·¸ì¸ ì—†ìŒ</span>'}</td>
                            </tr>
                            <tr>
                                <td><strong>ìƒíƒœ:</strong></td>
                                <td>${user.email_confirmed_at ? '<span class="badge badge-success">í™œì„±</span>' : '<span class="badge badge-warning">ë¹„í™œì„±</span>'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;

            // ëª¨ë‹¬ í‘œì‹œ
            $('#userDetailModal').modal('show');
        }

        // ì‚¬ìš©ì ìˆ˜ì •
        function editUser(userId) {
            const user = globalUsers.find(u => u.id === userId);
            if (!user) {
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ìˆ˜ì • í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserStatus').value = user.email_confirmed_at ? 'active' : 'inactive';

            // ëª¨ë‹¬ í‘œì‹œ
            $('#editUserModal').modal('show');
        }

        // ì‚¬ìš©ì ì‚­ì œ
        function deleteUser(userId) {
            const user = globalUsers.find(u => u.id === userId);
            if (!user) {
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ì— ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('deleteUserName').textContent = user.name || 'ì´ë¦„ ì—†ìŒ';
            document.getElementById('deleteUserEmail').textContent = user.email;
            document.getElementById('confirmDeleteUserId').value = userId;

            // ëª¨ë‹¬ í‘œì‹œ
            $('#deleteUserModal').modal('show');
        }

        // ì‚¬ìš©ì ìˆ˜ì • ì €ì¥
        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value;
            const email = document.getElementById('editUserEmail').value;
            const status = document.getElementById('editUserStatus').value;

            if (!name || !email) {
                showToast('ì´ë¦„ê³¼ ì´ë©”ì¼ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Supabase APIë¥¼ í†µí•´ ì—…ë°ì´íŠ¸
                // í˜„ì¬ëŠ” ë¡œì»¬ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
                const userIndex = globalUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    globalUsers[userIndex].name = name;
                    globalUsers[userIndex].email = email;
                    globalUsers[userIndex].email_confirmed_at = status === 'active' ? new Date().toISOString() : null;
                    
                    // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    displayRealUsers();
                    
                    $('#editUserModal').modal('hide');
                    showToast('ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ìˆ˜ì • ì—ëŸ¬:', error);
                showToast('ì‚¬ìš©ì ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì ì‚­ì œ í™•ì¸
        async function confirmDeleteUser() {
            const userId = document.getElementById('confirmDeleteUserId').value;
            
            try {
                // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Supabase APIë¥¼ í†µí•´ ì‚­ì œ
                // í˜„ì¬ëŠ” ë¡œì»¬ ë°ì´í„°ì—ì„œë§Œ ì œê±°
                const userIndex = globalUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    const deletedUser = globalUsers.splice(userIndex, 1)[0];
                    
                    // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    displayRealUsers();
                    
                    $('#deleteUserModal').modal('hide');
                    showToast(`ì‚¬ìš©ì "${deletedUser.name || deletedUser.email}"ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì—ëŸ¬:', error);
                showToast('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, type = 'success') {
            const existingToast = document.getElementById('users-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'users-toast';
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                    <button type="button" class="close ml-auto" onclick="this.parentElement.parentElement.remove()">
                        <span>&times;</span>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html> 