<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>강좌 관리 - 바로교육 관리자</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Korean Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .content-wrapper {
            background: #f4f4f4;
        }
        .card {
            box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
            border-radius: .25rem;
        }
        .brand-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-dark-primary .nav-sidebar > .nav-item > .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .course-thumbnail {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-published {
            background: #d4edda;
            color: #155724;
        }
        .status-draft {
            background: #f8d7da;
            color: #721c24;
        }
        .course-price {
            font-weight: 600;
            color: #007bff;
        }
        .course-rating {
            color: #ffc107;
        }
        
        /* 모달 스타일 개선 */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 20px 30px;
            border-bottom: none;
        }
        
        .modal-header .modal-title {
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        .modal-header .close {
            color: white;
            opacity: 0.8;
            font-size: 1.5rem;
            text-shadow: none;
        }
        
        .modal-header .close:hover {
            opacity: 1;
            color: white;
        }
        
        .modal-body {
            padding: 30px;
            background: #f8f9fa;
        }
        
        .modal-footer {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 20px 30px;
            border-radius: 0 0 12px 12px;
        }
        
        /* 기존 폼 필드 스타일 (아래 섹션에서 재정의됨) */
        
        .form-control {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            line-height: 1.5;
            height: 48px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-control::placeholder {
            color: #6c757d;
            opacity: 0.8;
        }
        
        /* Textarea는 높이 자동 조정 */
        textarea.form-control {
            height: auto;
            min-height: 100px;
            resize: vertical;
        }
        
        /* Select 박스 스타일 개선 */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
        }
        
        .custom-file-label {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 48px;
            display: flex;
            align-items: center;
            line-height: 1.5;
            background-color: #fff;
        }
        
        .custom-file-label:hover {
            background-color: #f8f9fa;
            border-color: #ccc;
        }
        
        .custom-file-input:focus ~ .custom-file-label {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .custom-file-label::after {
            content: "Browse";
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 3;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #495057;
            background-color: #e9ecef;
            border-left: 1px solid #e0e0e0;
            border-radius: 0 8px 8px 0;
            font-weight: 500;
        }
        
        /* 버튼 스타일 개선 */
        .btn {
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        /* 진행바 스타일 개선 */
        .progress {
            border-radius: 10px;
            height: 8px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 10px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        /* 알림 스타일 개선 */
        .alert {
            border-radius: 8px;
            border: none;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #0d47a1;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
        }
        
        /* 폼 섹션 구분 */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }
        
        .form-section-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.15rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .form-section-title i {
            color: #667eea;
        }
        
        /* 폼 그룹 간격 조정 */
        .form-group {
            margin-bottom: 1.8rem;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        /* 라벨 스타일 개선 */
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        
        .form-group label i {
            color: #667eea;
            width: 16px;
        }
        
        /* 도움말 텍스트 스타일 개선 */
        .form-text {
            margin-top: 6px;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        /* 체크박스 스타일 개선 */
        .form-check {
            padding: 12px 0;
            display: flex;
            align-items: center;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 0;
            margin-right: 8px;
            position: static;
        }
        
        .form-check-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        /* 무료 강좌 체크박스 간단하게 */
        .simple-check {
            margin-top: 8px;
            margin-left: 15px;
        }
        
        /* 반응형 개선 */
        @media (max-width: 768px) {
            .modal-dialog {
                margin: 10px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                padding: 15px 20px;
            }
        }

        /* 수강자 관리 모달 스타일 개선 */
        .students-modal .modal-content {
            border-radius: 15px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
        }

        .students-modal .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px 15px 0 0;
        }

        .students-modal .card {
            border: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .students-modal .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
        }

        .students-modal .card-header h6 {
            margin: 0;
            font-weight: 600;
            color: #2c3e50;
        }

        .students-modal .card-body {
            padding: 20px;
        }

        /* 테이블 행 호버 효과 */
        .table-row-hover:hover {
            background-color: #f8f9fa !important;
            transform: translateY(-1px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 사용자 아바타 스타일 */
        .user-avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            color: white;
            font-size: 18px;
        }

        .user-avatar i {
            color: white !important;
        }

        /* 검색 및 필터 스타일 개선 */
        .students-modal .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .students-modal .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background-color: #fff;
        }

        /* 배지 스타일 개선 */
        .badge {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 6px;
        }

        .badge-light {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        /* 진행률 바 스타일 개선 */
        .progress {
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .progress-bar {
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 0.6s ease;
        }

        /* 버튼 스타일 개선 */
        .btn-outline-success {
            border: 2px solid #28a745;
            color: #28a745;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-success:hover {
            background: #28a745;
            border-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-outline-warning {
            border: 2px solid #ffc107;
            color: #856404;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-warning:hover {
            background: #ffc107;
            border-color: #ffc107;
            color: #212529;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        /* 전체 권한 버튼 스타일 */
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #1e9b88 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            border: none;
            color: #212529;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e67e00 100%);
            color: #212529;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        /* 테이블 헤더 스타일 개선 */
        .students-modal table thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
            padding: 15px 12px;
            text-align: center;
            vertical-align: middle;
        }

        .students-modal table tbody td {
            padding: 15px 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f3f4;
        }

        /* DataTables 검색 박스 스타일 */
        .dataTables_filter input[type="search"] {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 8px 12px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .dataTables_filter input[type="search"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        /* DataTables 페이지네이션 스타일 */
        .dataTables_paginate .pagination {
            margin: 0;
        }

        .dataTables_paginate .page-link {
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 8px 12px;
            margin: 0 2px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .dataTables_paginate .page-link:hover {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .dataTables_paginate .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        /* 강좌 정보 카드 스타일 */
        .course-info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .course-info-card h5 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .course-info-card p {
            color: #6c757d;
            margin-bottom: 0;
        }

        /* 탭 스타일 개선 */
        .nav-tabs .nav-link {
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background-color: #f8f9fa;
            color: #495057;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <!-- 네비게이션 바 -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- 왼쪽 네비게이션 -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                        <i class="fas fa-bars"></i>
                    </a>
                </li>
            </ul>

            <!-- 오른쪽 네비게이션 -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="far fa-user"></i>
                        <span class="ml-1" id="admin-name">관리자</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user mr-2"></i> 프로필
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" onclick="logoutUser()">
                            <i class="fas fa-sign-out-alt mr-2"></i> 로그아웃
                        </a>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- 메인 사이드바 -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- 브랜드 로고 -->
            <a href="index.html" class="brand-link">
                <img src="../images/logo.png" alt="바로교육" class="brand-image img-circle elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">바로교육 관리자</span>
            </a>

            <!-- 사이드바 -->
            <div class="sidebar">
                <!-- 사이드바 메뉴 -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>대시보드</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="users.html" class="nav-link">
                                <i class="nav-icon fas fa-users"></i>
                                <p>사용자 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="courses.html" class="nav-link active">
                                <i class="nav-icon fas fa-book"></i>
                                <p>강좌 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="reviews.html" class="nav-link">
                                <i class="nav-icon fas fa-star"></i>
                                <p>후기 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="payments.html" class="nav-link">
                                <i class="nav-icon fas fa-credit-card"></i>
                                <p>결제 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="statistics.html" class="nav-link">
                                <i class="nav-icon fas fa-chart-pie"></i>
                                <p>통계</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="settings.html" class="nav-link">
                                <i class="nav-icon fas fa-cogs"></i>
                                <p>설정</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- 콘텐츠 래퍼 -->
        <div class="content-wrapper">
            <!-- 콘텐츠 헤더 -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">강좌 관리</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="index.html">홈</a></li>
                                <li class="breadcrumb-item active">강좌 관리</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 콘텐츠 -->
            <section class="content">
                <div class="container-fluid">
                    <!-- 강좌 목록 카드 -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">강좌 목록</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
                                    <i class="fas fa-plus"></i> 새 강좌 추가
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="courses-table" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>썸네일</th>
                                            <th>제목</th>
                                            <th>강사</th>
                                            <th>카테고리</th>
                                            <th>가격</th>
                                            <th>평점</th>
                                            <th>수강생</th>
                                            <th>영상</th>
                                            <th>상태</th>
                                            <th>생성일</th>
                                            <th>작업</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 동적으로 로드됨 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 푸터 -->
        <footer class="main-footer">
            <strong>Copyright &copy; 2024 바로교육.</strong>
            All rights reserved.
            <div class="float-right d-none d-sm-inline-block">
                <b>Version</b> 1.0.0
            </div>
        </footer>
    </div>

    <!-- 강좌 추가/수정 모달 -->
    <div class="modal fade" id="course-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-title">강좌 추가</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 탭 네비게이션 -->
                    <ul class="nav nav-tabs" id="course-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic-info" role="tab">
                                <i class="fas fa-info-circle mr-1"></i>기본 정보
                            </a>
                        </li>
                        <li class="nav-item" id="students-tab-nav" style="display: none;">
                            <a class="nav-link" id="students-tab" data-toggle="tab" href="#students-management" role="tab">
                                <i class="fas fa-users mr-1"></i>수강자 관리
                            </a>
                        </li>
                    </ul>
                    
                    <!-- 탭 콘텐츠 -->
                    <div class="tab-content" id="course-tab-content">
                        <!-- 기본 정보 탭 -->
                        <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
                            <form id="course-form">
                                <div class="pt-3">
                        <input type="hidden" id="course-id">
                        
                        <!-- 기본 정보 섹션 -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-info-circle mr-2"></i>기본 정보
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="course-title">강좌 제목 *</label>
                                        <input type="text" class="form-control" id="course-title" required 
                                               placeholder="예: SNS 마케팅 마스터 클래스">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="course-status">상태</label>
                                        <select class="form-control" id="course-status">
                                            <option value="draft">임시저장</option>
                                            <option value="published" selected>게시</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course-instructor">강사명 *</label>
                                        <input type="text" class="form-control" id="course-instructor" required 
                                               placeholder="예: 김마케팅">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course-category">카테고리</label>
                                        <select class="form-control" id="course-category">
                                            <option value="marketing">마케팅</option>
                                            <option value="branding">브랜드</option>
                                            <option value="development">창업</option>
                                            <option value="crm">CRM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="course-description">상세 설명</label>
                                <textarea class="form-control" id="course-description" rows="4" 
                                          placeholder="강좌의 목표, 내용, 수강 대상 등을 자세히 설명해주세요."></textarea>
                            </div>
                        </div>

                        <!-- 가격 및 옵션 섹션 -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-won-sign mr-2"></i>가격 및 옵션
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course-price">
                                            <i class="fas fa-won-sign mr-2"></i>가격 (원)
                                        </label>
                                        <input type="number" class="form-control" id="course-price" min="0" 
                                               placeholder="99000">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course-difficulty">
                                            <i class="fas fa-layer-group mr-2"></i>난이도
                                        </label>
                                        <select class="form-control" id="course-difficulty">
                                            <option value="beginner">초급</option>
                                            <option value="intermediate">중급</option>
                                            <option value="advanced">고급</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 무료 강좌 옵션 -->
                            <div class="simple-check">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="course-is-free">
                                    <label class="form-check-label" for="course-is-free">
                                        무료 강좌로 설정
                                    </label>
                                </div>
                                <small class="text-muted ml-4">
                                    체크하면 가격이 무시되고 무료 강좌로 등록됩니다.
                                </small>
                            </div>
                        </div>

                        <!-- 미디어 파일 섹션 -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-photo-video mr-2"></i>미디어 파일
                            </div>
                            

                            <!-- 썸네일 이미지 업로드 -->
                            <div class="form-group">
                                <label for="course-thumbnail">
                                    <i class="fas fa-image mr-2"></i>썸네일 이미지
                                </label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="course-thumbnail" accept="image/*">
                                    <label class="custom-file-label" for="course-thumbnail">썸네일 이미지를 선택하세요</label>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    지원 형식: JPG, PNG, GIF (최대 5MB) - 강좌 목록에 표시될 대표 이미지입니다.
                                </small>
                            </div>
                            
                            

                            <!-- 영상 파일 업로드 -->
                            <div class="form-group">
                                <label for="course-video">
                                    <i class="fas fa-video mr-2"></i>영상 파일 업로드
                                </label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="course-video" accept="video/mp4,video/webm,video/avi,video/mov">
                                    <label class="custom-file-label" for="course-video">영상 파일을 선택하세요</label>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    지원 형식: MP4, WebM, AVI, MOV (최대 100MB) - 50MB 이상 파일은 자동 압축됩니다.
                                </small>
                            </div>
                            
                            <!-- 업로드 진행률 -->
                            <div class="progress mt-2" id="upload-progress" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
                                    <span class="sr-only">0% 완료</span>
                                </div>
                            </div>
                            
                            <!-- 압축 상태 -->
                            <div class="alert alert-info mt-2" id="compression-status" style="display: none;">
                                <i class="fas fa-compress-arrows-alt mr-2"></i>영상 압축 중... 잠시만 기다려주세요.
                            </div>
                            
                            <!-- 업로드 성공 상태 -->
                            <div class="alert alert-success mt-2" id="upload-success" style="display: none;">
                                <i class="fas fa-check-circle mr-2"></i>영상 업로드가 완료되었습니다!
                            </div>

                            <div class="form-group mt-3">
                                <label for="course-video-url">영상 URL (직접 입력)</label>
                                <input type="url" class="form-control" id="course-video-url" 
                                       placeholder="https://example.com/video.mp4">
                                <small class="form-text text-muted">또는 기존 영상 URL을 직접 입력하세요</small>
                            </div>
                        </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 수강자 관리 탭 -->
                        <div class="tab-pane fade" id="students-management" role="tabpanel">
                            <div class="pt-3">
                                <!-- 강좌 정보 -->
                                                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-book mr-2"></i>강좌 정보
                                </div>
                                <div class="course-info-card">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h5 id="tab-course-title">강좌 제목</h5>
                                            <p class="text-muted" id="tab-course-instructor">강사명</p>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            <span class="badge badge-info" id="tab-course-status">상태</span>
                                            <span class="badge badge-secondary" id="tab-course-students">총 수강생: 0명</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <!-- 권한 관리 -->
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-users mr-2"></i>수강자 권한 관리
                                    </div>
                                    
                                    <!-- 전체 권한 관리 -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-globe mr-2"></i>전체 수강자 권한
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-8">
                                                    <p class="mb-0">모든 등록된 수강자에게 이 강좌에 대한 접근 권한을 부여합니다.</p>
                                                </div>
                                                <div class="col-md-4 text-right">
                                                    <button class="btn btn-success" id="tab-grant-all-access" onclick="grantAllAccessFromTab()">
                                                        <i class="fas fa-unlock mr-1"></i>전체 권한 부여
                                                    </button>
                                                    <button class="btn btn-warning ml-2" id="tab-revoke-all-access" onclick="revokeAllAccessFromTab()">
                                                        <i class="fas fa-lock mr-1"></i>전체 권한 제거
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 개별 수강자 관리 -->
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-user mr-2"></i>개별 수강자 관리
                                            </h6>
                                            <button class="btn btn-primary btn-sm" onclick="loadAllUsersInTab()">
                                                <i class="fas fa-refresh mr-1"></i>목록 새로고침
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <!-- 수강자 검색 -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="tab-student-search" placeholder="이름 또는 이메일로 검색...">
                                                </div>
                                                <div class="col-md-6">
                                                    <select class="form-control" id="tab-enrollment-filter">
                                                        <option value="all">전체 사용자</option>
                                                        <option value="enrolled">수강 중</option>
                                                        <option value="not-enrolled">미등록</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- 수강자 목록 테이블 -->
                                            <div class="table-responsive">
                                                <table id="tab-students-table" class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>이름</th>
                                                            <th>이메일</th>
                                                            <th>수강 상태</th>
                                                            <th>진도율</th>
                                                            <th>등록일</th>
                                                            <th>작업</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- 동적으로 로드됨 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <small class="text-muted">* 필수 입력 항목</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">
                                <i class="fas fa-times mr-1"></i>취소
                            </button>
                            <button type="submit" class="btn btn-primary" id="save-course-btn">
                                <i class="fas fa-save mr-1"></i>저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 수강자 관리 모달 -->
    <div class="modal fade students-modal" id="students-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="students-modal-title">수강자 관리</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="manage-course-id">
                    
                    <!-- 강좌 정보 -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-book mr-2"></i>강좌 정보
                        </div>
                        <div class="course-info-card">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 id="manage-course-title">강좌 제목</h5>
                                    <p class="text-muted" id="manage-course-instructor">강사명</p>
                                </div>
                                <div class="col-md-4 text-right">
                                    <span class="badge badge-info" id="manage-course-status">상태</span>
                                    <span class="badge badge-secondary" id="manage-course-students">총 수강생: 0명</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 권한 관리 -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-users mr-2"></i>수강자 권한 관리
                        </div>
                        
                        <!-- 전체 권한 관리 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe mr-2"></i>전체 수강자 권한
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <p class="mb-0">모든 등록된 수강자에게 이 강좌에 대한 접근 권한을 부여합니다.</p>
                                    </div>
                                    <div class="col-md-4 text-right">
                                        <button class="btn btn-success" id="grant-all-access" onclick="grantAllAccess()">
                                            <i class="fas fa-unlock mr-1"></i>전체 권한 부여
                                        </button>
                                        <button class="btn btn-warning ml-2" id="revoke-all-access" onclick="revokeAllAccess()">
                                            <i class="fas fa-lock mr-1"></i>전체 권한 제거
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 개별 수강자 관리 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-user mr-2"></i>개별 수강자 관리
                                </h6>
                                <button class="btn btn-primary btn-sm" onclick="loadAllUsers()">
                                    <i class="fas fa-refresh mr-1"></i>목록 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 수강자 검색 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="student-search" placeholder="이름 또는 이메일로 검색...">
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-control" id="enrollment-filter">
                                            <option value="all">전체 사용자</option>
                                            <option value="enrolled">수강 중</option>
                                            <option value="not-enrolled">미등록</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 수강자 목록 테이블 -->
                                <div class="table-responsive">
                                    <table id="students-table" class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>이름</th>
                                                <th>이메일</th>
                                                <th>수강 상태</th>
                                                <th>진도율</th>
                                                <th>등록일</th>
                                                <th>작업</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 동적으로 로드됨 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>닫기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- FFmpeg.js for video compression -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js"></script>
    
    <script>
        // ===============================
        // Supabase 설정 (인라인으로 모든 코드 포함)
        // ===============================
        const SUPABASE_URL = 'https://bjsstktiiniigdnsdwsr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqc3N0a3RpaW5paWdkbnNkd3NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MDI4MTEsImV4cCI6MjA2NzA3ODgxMX0.h3W1Q3L_yX8_HPOMmEluq2Qum_INJSCv9OKV4IZdYRs';
        
        const ADMIN_EMAILS = [
            'admin@baroedu.com',
            'manager@baroedu.com', 
            'test@baroedu.com'
        ];

        // Supabase 클라이언트 초기화
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase 클라이언트 초기화 완료');
            } else {
                console.warn('⚠️ Supabase 라이브러리 로드 실패 - 데모 모드로 작동');
            }
        } catch (error) {
            console.error('❌ Supabase 클라이언트 초기화 에러:', error);
            console.log('📝 데모 모드로 작동합니다.');
        }

        // ===============================
        // 전역 변수
        // ===============================
        let coursesTable = null;
        let currentUser = null;
        let ffmpeg = null;
        let uploadedVideoUrl = null;
        let uploadedThumbnailUrl = null;

        // ===============================
        // 전역 함수들 (모달 및 액션)
        // ===============================
        
        // 새 강좌 추가 모달 표시 (안전한 버전)
        function showAddCourseModal() {
            console.log('🔵 새 강좌 추가 모달 열기');
            try {
                // DOM 요소 존재 확인
                const modalTitle = document.getElementById('modal-title');
                const courseForm = document.getElementById('course-form');
                const courseId = document.getElementById('course-id');
                
                if (!modalTitle || !courseForm || !courseId) {
                    console.error('❌ 필수 DOM 요소 없음');
                    alert('페이지가 완전히 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                    return;
                }
                
                modalTitle.textContent = '새 강좌 추가';
                courseForm.reset();
                courseId.value = '';
                
                // 파일 입력 라벨 초기화 (안전하게)
                try {
                    const videoFileLabel = document.querySelector('#course-video').parentElement.querySelector('.custom-file-label');
                    const thumbnailFileLabel = document.querySelector('#course-thumbnail').parentElement.querySelector('.custom-file-label');
                    if (videoFileLabel) {
                        videoFileLabel.textContent = '영상 파일을 선택하세요';
                    }
                    if (thumbnailFileLabel) {
                        thumbnailFileLabel.textContent = '썸네일 이미지를 선택하세요';
                    }
                } catch (labelError) {
                    console.warn('파일 라벨 초기화 실패:', labelError);
                }
                
                // 상태 UI 초기화 (안전하게)
                try {
                    hideUploadProgress();
                    hideCompressionStatus();
                    hideUploadSuccess();
                } catch (statusError) {
                    console.warn('상태 UI 초기화 실패:', statusError);
                }
                
                // 업로드 변수 초기화
                uploadedVideoUrl = null;
                uploadedThumbnailUrl = null;
                
                // 수강자 관리 탭 숨기기 (새 강좌이므로)
                const studentsTabNav = document.getElementById('students-tab-nav');
                if (studentsTabNav) {
                    studentsTabNav.style.display = 'none';
                }
                
                // 기본 정보 탭 활성화
                try {
                    if (typeof $ !== 'undefined' && $.fn.tab) {
                        $('.nav-tabs a[href="#basic-info"]').tab('show');
                    }
                } catch (tabError) {
                    console.warn('탭 활성화 실패:', tabError);
                }
                
                // 모달 열기
                try {
                    if (typeof $ !== 'undefined' && $.fn.modal) {
                        $('#course-modal').modal('show');
                    } else {
                        // Bootstrap이 없는 경우 대체 방법
                        const modal = document.getElementById('course-modal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.classList.add('show');
                        }
                    }
                    console.log('✅ 모달 열기 성공');
                } catch (modalError) {
                    console.error('❌ 모달 열기 실패:', modalError);
                    alert('모달을 여는 중 오류가 발생했습니다: ' + modalError.message);
                }
                
            } catch (error) {
                console.error('❌ 모달 열기 전체 에러:', error);
                alert('모달을 여는 중 오류가 발생했습니다. 페이지를 새로고침 후 다시 시도해주세요.');
            }
        }

        // 영상 재생
        function playVideo(videoUrl) {
            if (!videoUrl) {
                alert('영상 URL이 없습니다.');
                return;
            }
            window.open(videoUrl, '_blank', 'width=800,height=600');
        }

        // 수강자 관리 모달 열기
        async function viewCourse(courseId) {
            try {
                console.log('🔵 수강자 관리 모달 열기:', courseId);
                
                // 강좌 정보 조회
                const { data: course, error } = await supabase
                    .from('courses')
                    .select('*')
                    .eq('id', courseId)
                    .single();

                if (error) {
                    console.error('강좌 조회 에러:', error);
                    showToast('강좌 정보를 불러올 수 없습니다.', 'error');
                    return;
                }

                // 모달에 강좌 정보 표시
                document.getElementById('manage-course-id').value = courseId;
                document.getElementById('manage-course-title').textContent = course.title || '제목 없음';
                document.getElementById('manage-course-instructor').textContent = `강사: ${course.instructor_name || '미정'}`;
                document.getElementById('manage-course-status').textContent = course.status === 'published' ? '게시' : '임시저장';
                document.getElementById('manage-course-status').className = course.status === 'published' ? 'badge badge-success' : 'badge badge-warning';
                
                // 수강생 수 조회
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                const studentCount = enrollments ? enrollments.length : 0;
                document.getElementById('manage-course-students').textContent = `총 수강생: ${studentCount}명`;
                
                // 모달 열기
                $('#students-modal').modal('show');
                
                // 모달이 완전히 열린 후 수강자 목록 로드
                $('#students-modal').on('shown.bs.modal', function () {
                    // 이벤트 리스너 중복 방지
                    $('#students-modal').off('shown.bs.modal');
                    
                    // 수강자 목록 로드
                    loadStudentsForCourse(courseId);
                    
                    // 테이블 컬럼 재조정
                    setTimeout(() => {
                        if (studentsTable) {
                            studentsTable.columns.adjust().draw();
                        }
                    }, 300);
                });
                
            } catch (error) {
                console.error('수강자 관리 모달 에러:', error);
                showToast('수강자 관리 모달을 여는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 강좌 수정
        async function editCourse(courseId) {
            try {
                console.log('🔵 강좌 수정 모달 열기:', courseId);
                
                // 강좌 데이터 조회
                const { data: course, error } = await supabase
                    .from('courses')
                    .select('*')
                    .eq('id', courseId)
                    .single();

                if (error) {
                    console.error('강좌 조회 에러:', error);
                    showToast('강좌 정보를 불러올 수 없습니다.', 'error');
                    return;
                }

                // 모달 제목 변경
                document.getElementById('modal-title').textContent = '강좌 수정';
                
                // 폼에 기존 데이터 채우기
                document.getElementById('course-id').value = course.id;
                document.getElementById('course-title').value = course.title || '';
                document.getElementById('course-instructor').value = course.instructor_name || '';
                document.getElementById('course-category').value = course.category_id || 'marketing';
                document.getElementById('course-price').value = course.price || 0;
                document.getElementById('course-difficulty').value = course.difficulty || 'beginner';
                document.getElementById('course-description').value = course.description || '';
                document.getElementById('course-status').value = course.status || 'draft';
                document.getElementById('course-is-free').checked = course.is_free || false;
                document.getElementById('course-video-url').value = course.video_url || '';
                
                // 파일 라벨 업데이트
                const videoFileLabel = document.querySelector('#course-video').parentElement.querySelector('.custom-file-label');
                const thumbnailFileLabel = document.querySelector('#course-thumbnail').parentElement.querySelector('.custom-file-label');
                
                if (course.video_url) {
                    videoFileLabel.textContent = '기존 영상 파일 있음';
                } else {
                    videoFileLabel.textContent = '영상 파일을 선택하세요';
                }
                
                if (course.thumbnail_url) {
                    thumbnailFileLabel.textContent = '기존 썸네일 있음';
                    uploadedThumbnailUrl = course.thumbnail_url;
                } else {
                    thumbnailFileLabel.textContent = '썸네일 이미지를 선택하세요';
                }
                
                if (course.video_url) {
                    uploadedVideoUrl = course.video_url;
                }
                
                // 수강자 관리 탭 표시 및 정보 로드
                document.getElementById('students-tab-nav').style.display = 'block';
                
                // 탭에 강좌 정보 표시
                document.getElementById('tab-course-title').textContent = course.title || '제목 없음';
                document.getElementById('tab-course-instructor').textContent = `강사: ${course.instructor_name || '미정'}`;
                document.getElementById('tab-course-status').textContent = course.status === 'published' ? '게시' : '임시저장';
                document.getElementById('tab-course-status').className = course.status === 'published' ? 'badge badge-success' : 'badge badge-warning';
                
                // 수강생 수 로드
                await updateStudentCount(course.id);
                
                // 상태 UI 초기화
                hideUploadProgress();
                hideCompressionStatus();
                hideUploadSuccess();
                
                // 기본 정보 탭 활성화
                $('.nav-tabs a[href="#basic-info"]').tab('show');
                
                // 모달 열기
                $('#course-modal').modal('show');
                
            } catch (error) {
                console.error('강좌 수정 모달 에러:', error);
                showToast('강좌 수정 중 오류가 발생했습니다.', 'error');
            }
        }

        // 강좌 삭제
        function deleteCourse(courseId) {
            if (confirm('정말로 이 강좌를 삭제하시겠습니까?')) {
                alert('강좌 삭제 기능은 준비 중입니다.');
            }
        }

        // 로그아웃
        function logoutUser() {
            if (confirm('정말로 로그아웃하시겠습니까?')) {
                try {
                    supabase.auth.signOut();
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('로그아웃 에러:', error);
                    window.location.href = 'login.html';
                }
            }
        }

        // ===============================
        // 영상 파일 처리 함수들
        // ===============================
        
        // FFmpeg 초기화
        async function initFFmpeg() {
            try {
                if (ffmpeg) return ffmpeg;
                
                // 동적으로 FFmpeg 로드
                const { FFmpeg } = await import('https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.js');
                const { fetchFile, toBlobURL } = await import('https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js');
                
                ffmpeg = new FFmpeg();
                
                const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm';
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                    workerURL: await toBlobURL(`${baseURL}/ffmpeg-core.worker.js`, 'text/javascript')
                });
                
                console.log('✅ FFmpeg 초기화 완료');
                return ffmpeg;
            } catch (error) {
                console.error('❌ FFmpeg 초기화 에러:', error);
                return null;
            }
        }

        // 영상 압축
        async function compressVideo(file) {
            try {
                console.log('🔄 영상 압축 시작:', file.name);
                
                const ffmpegInstance = await initFFmpeg();
                if (!ffmpegInstance) {
                    throw new Error('FFmpeg 초기화 실패');
                }

                const { fetchFile } = await import('https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js');
                
                // 입력 파일 등록
                await ffmpegInstance.writeFile('input.mp4', await fetchFile(file));
                
                // 압축 옵션 설정 (720p, H.264, CRF 23)
                await ffmpegInstance.exec([
                    '-i', 'input.mp4',
                    '-c:v', 'libx264',
                    '-crf', '23',
                    '-preset', 'medium',
                    '-vf', 'scale=-2:720',
                    '-c:a', 'aac',
                    '-b:a', '128k',
                    'output.mp4'
                ]);
                
                // 압축된 파일 읽기
                const data = await ffmpegInstance.readFile('output.mp4');
                const compressedBlob = new Blob([data.buffer], { type: 'video/mp4' });
                
                // 파일 정리
                await ffmpegInstance.deleteFile('input.mp4');
                await ffmpegInstance.deleteFile('output.mp4');
                
                console.log(`✅ 영상 압축 완료: ${file.size} → ${compressedBlob.size} bytes`);
                return compressedBlob;
            } catch (error) {
                console.error('❌ 영상 압축 에러:', error);
                throw error;
            }
        }

        // Supabase Storage에 영상 업로드
        async function uploadVideoToStorage(file, fileName) {
            try {
                console.log('🔄 Supabase Storage에 업로드 시작:', fileName);
                
                const { data, error } = await supabase.storage
                    .from('course-videos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) {
                    throw error;
                }

                // 공개 URL 생성
                const { data: { publicUrl } } = supabase.storage
                    .from('course-videos')
                    .getPublicUrl(fileName);

                console.log('✅ 업로드 완료:', publicUrl);
                return publicUrl;
            } catch (error) {
                console.error('❌ 업로드 에러:', error);
                throw error;
            }
        }

        // 영상 파일 처리 (압축 + 업로드)
        async function processVideoFile(file) {
            try {
                const maxSize = 100 * 1024 * 1024; // 100MB
                const shouldCompress = file.size > 50 * 1024 * 1024; // 50MB 이상 시 압축
                
                // UI 업데이트
                showUploadProgress(0);
                
                // 파일 크기 체크
                if (file.size > maxSize) {
                    showCompressionStatus('파일 크기가 100MB를 초과합니다. 압축을 시도합니다.');
                }

                let processedFile = file;

                // 압축 필요 시 압축 실행
                if (shouldCompress) {
                    try {
                        showCompressionStatus('영상 압축 중...');
                        processedFile = await compressVideo(file);
                        hideCompressionStatus();
                        
                        // 압축 후에도 크기가 클 경우
                        if (processedFile.size > maxSize) {
                            throw new Error('압축 후에도 파일 크기가 너무 큽니다.');
                        }
                    } catch (compressError) {
                        console.warn('압축 실패, 원본 파일 사용:', compressError);
                        hideCompressionStatus();
                        processedFile = file;
                    }
                }

                // Supabase Storage에 업로드
                showUploadProgress(50);
                
                const fileName = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.mp4`;
                const videoUrl = await uploadVideoToStorage(processedFile, fileName);
                
                showUploadProgress(100);
                uploadedVideoUrl = videoUrl;
                
                // 성공 상태 표시
                showUploadSuccess();
                setTimeout(() => {
                    hideUploadProgress();
                }, 1000);
                
                return videoUrl;
            } catch (error) {
                console.error('❌ 영상 파일 처리 에러:', error);
                hideUploadProgress();
                hideCompressionStatus();
                throw error;
            }
        }

        // UI 헬퍼 함수들
        function showUploadProgress(percent) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        function hideUploadProgress() {
            document.getElementById('upload-progress').style.display = 'none';
        }

        function showCompressionStatus(message) {
            const statusDiv = document.getElementById('compression-status');
            statusDiv.style.display = 'block';
            statusDiv.querySelector('i').nextSibling.textContent = ' ' + message;
        }

        function hideCompressionStatus() {
            document.getElementById('compression-status').style.display = 'none';
        }

        function showUploadSuccess() {
            document.getElementById('upload-success').style.display = 'block';
        }

        function hideUploadSuccess() {
            document.getElementById('upload-success').style.display = 'none';
        }

        // 썸네일 이미지 업로드
        async function uploadThumbnailToStorage(file, fileName) {
            try {
                console.log('🔄 썸네일 이미지 업로드 시작:', fileName);
                
                const { data, error } = await supabase.storage
                    .from('course-thumbnails')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) {
                    throw error;
                }

                // 공개 URL 생성
                const { data: { publicUrl } } = supabase.storage
                    .from('course-thumbnails')
                    .getPublicUrl(fileName);

                console.log('✅ 썸네일 업로드 완료:', publicUrl);
                return publicUrl;
            } catch (error) {
                console.error('❌ 썸네일 업로드 에러:', error);
                throw error;
            }
        }

        // 썸네일 이미지 처리
        async function processThumbnailFile(file) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                // 파일 크기 체크
                if (file.size > maxSize) {
                    throw new Error('썸네일 이미지는 5MB 이하여야 합니다.');
                }

                // 이미지 파일 형식 체크
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('지원하지 않는 이미지 형식입니다. (JPG, PNG, GIF, WebP만 지원)');
                }

                // Supabase Storage에 업로드
                const fileName = `thumbnail_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${file.type.split('/')[1]}`;
                const thumbnailUrl = await uploadThumbnailToStorage(file, fileName);
                
                uploadedThumbnailUrl = thumbnailUrl;
                
                return thumbnailUrl;
            } catch (error) {
                console.error('❌ 썸네일 처리 에러:', error);
                throw error;
            }
        }

        // ===============================
        // 인증 관련 함수들
        // ===============================
        
        // 인증 확인
        async function checkAuth() {
            try {
                console.log('🔵 인증 확인 시작');
                
                // Supabase가 초기화되지 않은 경우 데모 사용자 반환
                if (!supabase) {
                    console.warn('⚠️ Supabase 없음 - 데모 관리자로 로그인');
                    const demoUser = {
                        id: 'demo-admin',
                        email: 'admin@baroedu.com',
                        user_metadata: { name: '데모 관리자' }
                    };
                    currentUser = demoUser;
                    return demoUser;
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('❌ 사용자 없음');
                    throw new Error('인증되지 않은 사용자입니다.');
                }

                // 관리자 이메일 확인
                if (!ADMIN_EMAILS.includes(user.email.toLowerCase())) {
                    console.log('❌ 관리자 권한 없음:', user.email);
                    throw new Error('관리자 권한이 없습니다.');
                }

                console.log('✅ 인증 성공:', user.email);
                currentUser = user;
                return user;
                
            } catch (error) {
                console.error('❌ 인증 에러:', error);
                // 인증 실패 시에도 데모 모드로 작동
                const demoUser = {
                    id: 'demo-admin',
                    email: 'admin@baroedu.com',
                    user_metadata: { name: '데모 관리자' }
                };
                currentUser = demoUser;
                return demoUser;
            }
        }

        // ===============================
        // 강좌 관리 함수들
        // ===============================
        
        // 강좌 테이블 초기화
        async function initCoursesTable() {
            try {
                if (coursesTable) {
                    coursesTable.destroy();
                }

                coursesTable = $('#courses-table').DataTable({
                    responsive: true,
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_개)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "강좌 데이터가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 25,
                    order: [[9, 'desc']],
                    columnDefs: [
                        { targets: [0, 7, 10], orderable: false },
                        { targets: [4], className: 'text-right' },
                        { targets: [5, 6, 7], className: 'text-center' },
                        { targets: [9], type: 'date' }
                    ]
                });
                
                console.log('✅ 강좌 테이블 초기화 완료');
            } catch (error) {
                console.error('강좌 테이블 초기화 에러:', error);
            }
        }

        // 강좌 목록 로드
        async function loadCourses() {
            try {
                console.log('🔄 강좌 목록 로드 중...');
                
                // Supabase가 없으면 바로 샘플 데이터 표시
                if (!supabase) {
                    console.log('📝 Supabase 없음 - 샘플 데이터 표시');
                    displaySampleCourses();
                    return;
                }
                
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('강좌 목록 조회 에러:', error);
                    displaySampleCourses();
                    return;
                }

                if (coursesTable) {
                    coursesTable.clear();
                    
                    if (courses && courses.length > 0) {
                        courses.forEach(course => {
                            const row = createCourseRow(course);
                            coursesTable.row.add(row);
                        });
                        console.log(`✅ 강좌 ${courses.length}개 로드 완료`);
                    } else {
                        console.log('📝 실제 강좌 데이터 없음 - 샘플 데이터 표시');
                        displaySampleCourses();
                        return;
                    }
                    
                    coursesTable.draw();
                }
                
            } catch (error) {
                console.error('강좌 목록 로드 에러:', error);
                displaySampleCourses();
            }
        }

        // 샘플 강좌 데이터 표시
        function displaySampleCourses() {
            if (!coursesTable) return;

            const realCourses = [
                {
                    id: '1',
                    title: 'SNS 마케팅 마스터',
                    instructor_name: '김마케팅',
                    category_id: 'marketing',
                    price: 99000,
                    rating: 4.8,
                    total_students: 150,
                    status: 'published',
                    thumbnail_url: '../images/pd1.jpg',
                    video_url: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',
                    created_at: '2024-01-15T10:30:00Z'
                },
                {
                    id: '2',
                    title: 'AI 상세페이지 최적화',
                    instructor_name: '이디자인',
                    category_id: 'branding',
                    price: 0,
                    is_free: true,
                    rating: 4.5,
                    total_students: 89,
                    status: 'published',
                    thumbnail_url: '../images/pd2.jpg',
                    video_url: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4',
                    created_at: '2024-01-10T15:45:00Z'
                },
                {
                    id: '3',
                    title: '바이럴 콘텐츠 기초부터 실전',
                    instructor_name: '박바이럴',
                    category_id: 'marketing',
                    price: 149000,
                    rating: 4.9,
                    total_students: 203,
                    status: 'published',
                    thumbnail_url: '../images/pd3.jpg',
                    video_url: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',
                    created_at: '2024-01-08T11:20:00Z'
                },
                {
                    id: '4',
                    title: '쇼핑몰 창업 A to Z',
                    instructor_name: '최창업',
                    category_id: 'development',
                    price: 199000,
                    rating: 4.7,
                    total_students: 132,
                    status: 'published',
                    thumbnail_url: '../images/pd4.jpg',
                    video_url: null,
                    created_at: '2024-01-05T14:20:00Z'
                },
                {
                    id: '5',
                    title: '고객 관리 시스템 구축',
                    instructor_name: '정시스템',
                    category_id: 'crm',
                    price: 129000,
                    rating: 4.6,
                    total_students: 78,
                    status: 'published',
                    thumbnail_url: '../images/pd11.jpg',
                    video_url: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4',
                    created_at: '2024-01-03T09:15:00Z'
                }
            ];

            coursesTable.clear();
            realCourses.forEach(course => {
                const row = createCourseRow(course);
                coursesTable.row.add(row);
            });
            coursesTable.draw();

            showToast('실제 바로교육 강좌 데이터를 표시합니다.', 'success');
        }

        // 강좌 행 생성
        function createCourseRow(course) {
            const thumbnail = course.thumbnail_url ? 
                `<img src="${course.thumbnail_url}" alt="썸네일" class="course-thumbnail" onerror="this.style.display='none'">` : 
                `<div class="course-thumbnail bg-secondary d-flex align-items-center justify-content-center">
                    <i class="fas fa-book text-white"></i>
                </div>`;
            
            const title = course.title || '제목 없음';
            const instructor = course.instructor_name || '강사 미정';
            const category = getCategoryName(course.category_id);
            const price = (course.is_free || course.price === 0) ? 
                '<span class="badge badge-success">무료</span>' :
                `<span class="course-price">${Number(course.price).toLocaleString()}원</span>`;
            
            const rating = course.rating ? 
                `<span class="course-rating">
                    <i class="fas fa-star"></i> ${course.rating}
                </span>` : 
                '<span class="text-muted">평가 없음</span>';
            
            const students = course.total_students || 0;
            
            const video = course.video_url ? 
                `<button class="btn btn-success btn-sm" onclick="playVideo('${course.video_url}')" title="영상 재생">
                    <i class="fas fa-play"></i>
                </button>` : 
                '<span class="text-muted">영상 없음</span>';
            
            const status = course.status === 'published' ? 
                '<span class="badge badge-success">게시</span>' : 
                '<span class="badge badge-warning">임시저장</span>';
            
            const createdAt = course.created_at ? formatDate(course.created_at) : '날짜 없음';
            
            const actions = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewCourse('${course.id}')" title="상세보기">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-warning" onclick="editCourse('${course.id}')" title="수정">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteCourse('${course.id}')" title="삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return [thumbnail, title, instructor, category, price, rating, students, video, status, createdAt, actions];
        }

        // ===============================
        // 유틸리티 함수들
        // ===============================
        
        // 카테고리 이름 변환
        function getCategoryName(categoryId) {
            const categories = {
                'marketing': '마케팅',
                'branding': '브랜드',
                'development': '창업',
                'crm': 'CRM'
            };
            return categories[categoryId] || categoryId || '기타';
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const existingToast = document.getElementById('courses-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'courses-toast';
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                    <button type="button" class="close ml-auto" onclick="this.parentElement.parentElement.remove()">
                        <span>&times;</span>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // ===============================
        // 폼 이벤트 리스너
        // ===============================
        
        // 미디어 파일 선택 이벤트 리스너
        function addMediaEventListeners() {
            // 영상 파일 이벤트 리스너
            const videoInput = document.getElementById('course-video');
            const videoFileLabel = videoInput?.parentElement.querySelector('.custom-file-label');
            
            if (videoInput && videoFileLabel) {
                videoInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        // 파일명 표시
                        videoFileLabel.textContent = file.name;
                        
                        // 상태 초기화
                        hideUploadProgress();
                        hideCompressionStatus();
                        hideUploadSuccess();
                        
                        // 영상 파일 처리 (압축 + 업로드)
                        const videoUrl = await processVideoFile(file);
                        
                        // 업로드된 URL을 input에 저장
                        document.getElementById('course-video-url').value = videoUrl;
                        
                        console.log('✅ 영상 업로드 완료:', videoUrl);
                    } catch (error) {
                        console.error('❌ 영상 파일 처리 에러:', error);
                        alert('영상 업로드 중 오류가 발생했습니다: ' + error.message);
                        
                        // 에러 시 파일명 초기화
                        videoFileLabel.textContent = '영상 파일을 선택하세요';
                        videoInput.value = '';
                    }
                });
            }

            // 썸네일 이미지 이벤트 리스너
            const thumbnailInput = document.getElementById('course-thumbnail');
            const thumbnailFileLabel = thumbnailInput?.parentElement.querySelector('.custom-file-label');
            
            if (thumbnailInput && thumbnailFileLabel) {
                thumbnailInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        // 파일명 표시
                        thumbnailFileLabel.textContent = file.name;
                        
                        // 썸네일 이미지 처리
                        const thumbnailUrl = await processThumbnailFile(file);
                        
                        console.log('✅ 썸네일 업로드 완료:', thumbnailUrl);
                        
                        // 성공 메시지 표시
                        showToast('썸네일 이미지가 성공적으로 업로드되었습니다!', 'success');
                        
                    } catch (error) {
                        console.error('❌ 썸네일 처리 에러:', error);
                        alert('썸네일 업로드 중 오류가 발생했습니다: ' + error.message);
                        
                        // 에러 시 파일명 초기화
                        thumbnailFileLabel.textContent = '썸네일 이미지를 선택하세요';
                        thumbnailInput.value = '';
                    }
                });
            }
        }
        
        // 폼 이벤트 리스너 추가
        function addFormEventListeners() {
            // 탭 변경 이벤트 리스너 추가
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const target = $(e.target).attr("href"); // 활성화된 탭
                
                if (target === '#students-management') {
                    // 수강자 관리 탭이 활성화될 때 데이터 로드
                    const courseId = document.getElementById('course-id').value;
                    if (courseId) {
                        console.log('🔵 수강자 관리 탭 활성화 - 데이터 로드:', courseId);
                        loadStudentsForCourseInTab(courseId);
                    }
                }
            });
            
            // 저장 버튼 클릭 이벤트 리스너
            const saveCourseBtn = document.getElementById('save-course-btn');
            if (saveCourseBtn) {
                saveCourseBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    try {
                        // 영상 업로드 확인
                        const videoUrlInput = document.getElementById('course-video-url').value;
                        const videoFile = document.getElementById('course-video').files[0];
                        
                        if (videoFile && !videoUrlInput) {
                            alert('영상 업로드가 진행 중입니다. 완료 후 다시 시도해주세요.');
                            return;
                        }
                        
                        // 무료 강좌인 경우 가격을 0으로 설정
                        const isFree = document.getElementById('course-is-free').checked;
                        const priceValue = isFree ? 0 : (parseInt(document.getElementById('course-price').value) || 0);
                        
                        // 실제 테이블 구조에 맞는 데이터 구성
                        const courseData = {
                            title: document.getElementById('course-title').value,
                            instructor_name: document.getElementById('course-instructor').value,
                            category_id: document.getElementById('course-category').value,
                            difficulty: document.getElementById('course-difficulty').value,
                            price: priceValue,
                            is_free: isFree,
                            description: document.getElementById('course-description').value,
                            thumbnail_url: uploadedThumbnailUrl || null,
                            video_url: videoUrlInput || uploadedVideoUrl || null,
                            status: document.getElementById('course-status').value
                        };

                        const existingCourseId = document.getElementById('course-id').value;
                        
                        if (existingCourseId) {
                            const { data, error } = await supabase
                                .from('courses')
                                .update(courseData)
                                .eq('id', existingCourseId);

                            if (error) {
                                throw new Error(`강좌 수정 에러: ${error.message}`);
                            }

                            showToast('강좌가 성공적으로 수정되었습니다.', 'success');
                        } else {
                            const { data, error } = await supabase
                                .from('courses')
                                .insert([courseData]);

                            if (error) {
                                throw new Error(`강좌 추가 에러: ${error.message}`);
                            }

                            showToast('새 강좌가 성공적으로 추가되었습니다.', 'success');
                        }
                        
                        // 폼 초기화
                        document.getElementById('course-form').reset();
                        const videoFileLabel = document.querySelector('#course-video').parentElement.querySelector('.custom-file-label');
                        const thumbnailFileLabel = document.querySelector('#course-thumbnail').parentElement.querySelector('.custom-file-label');
                        if (videoFileLabel) videoFileLabel.textContent = '영상 파일을 선택하세요';
                        if (thumbnailFileLabel) thumbnailFileLabel.textContent = '썸네일 이미지를 선택하세요';
                        uploadedVideoUrl = null;
                        uploadedThumbnailUrl = null;
                        
                        // 상태 UI 초기화
                        hideUploadProgress();
                        hideCompressionStatus();
                        hideUploadSuccess();
                        
                        // 탭 정보 업데이트 (수정 모드인 경우)
                        const editingCourseId = document.getElementById('course-id').value;
                        if (editingCourseId) {
                            // 수강자 관리 탭의 강좌 정보 업데이트
                            document.getElementById('tab-course-title').textContent = courseData.title || '제목 없음';
                            document.getElementById('tab-course-instructor').textContent = `강사: ${courseData.instructor_name || '미정'}`;
                            document.getElementById('tab-course-status').textContent = courseData.status === 'published' ? '게시' : '임시저장';
                            document.getElementById('tab-course-status').className = courseData.status === 'published' ? 'badge badge-success' : 'badge badge-warning';
                        }
                        
                        $('#course-modal').modal('hide');
                        await loadCourses();
                        
                    } catch (error) {
                        console.error('강좌 저장 에러:', error);
                        showToast(`강좌 저장 중 오류가 발생했습니다: ${error.message}`, 'error');
                    }
                });
            }
        }

        // ===============================
        // 페이지 초기화
        // ===============================
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('🔵 페이지 로드 시작');
                
                // 기본 함수들 먼저 전역으로 노출
                window.showAddCourseModal = showAddCourseModal;
                window.playVideo = playVideo;
                window.viewCourse = viewCourse;
                window.editCourse = editCourse;
                window.deleteCourse = deleteCourse;
                window.logoutUser = logoutUser;
                
                // 인증 확인
                const user = await checkAuth();
                
                if (user) {
                    console.log('✅ 인증된 사용자:', user.email);
                    document.getElementById('admin-name').textContent = user.email || '관리자';
                    await initCoursesPage();
                } else {
                    console.log('❌ 인증 실패 - 로그인 페이지로 이동');
                    window.location.href = 'login.html';
                }
                
            } catch (error) {
                console.error('❌ 페이지 초기화 에러:', error);
                // 인증 실패 시에도 기본 함수들은 사용 가능하도록
                window.showAddCourseModal = showAddCourseModal;
                showToast('인증에 실패했지만 데모 모드로 작동합니다.', 'warning');
                await initCoursesPage();
            }
        });

        // 강좌 관리 페이지 초기화
        async function initCoursesPage() {
            try {
                console.log('🔵 강좌 관리 페이지 초기화 시작');
                
                // 전역 함수 다시 확인 및 노출
                window.showAddCourseModal = showAddCourseModal;
                window.playVideo = playVideo;
                window.viewCourse = viewCourse;
                window.editCourse = editCourse;
                window.deleteCourse = deleteCourse;
                window.logoutUser = logoutUser;
                
                await initCoursesTable();
                await loadCourses();
                addFormEventListeners();
                addMediaEventListeners();
                
                // 버튼 이벤트 리스너 추가 (안전장치)
                const addCourseBtn = document.querySelector('button[onclick="showAddCourseModal()"]');
                if (addCourseBtn) {
                    addCourseBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showAddCourseModal();
                    });
                }
                
                console.log('✅ 강좌 관리 페이지 초기화 완료');
            } catch (error) {
                console.error('❌ 강좌 관리 페이지 초기화 에러:', error);
                showToast('일부 기능이 제한될 수 있지만 기본 기능은 사용 가능합니다.', 'warning');
                
                // 에러가 발생해도 기본 기능은 사용할 수 있도록 샘플 데이터 표시
                displaySampleCourses();
            }
        }

        // ===============================
        // 수강자 관리 함수들
        // ===============================
        
        let studentsTable = null;
        
        // 특정 강좌의 수강자 목록 로드
        async function loadStudentsForCourse(courseId) {
            try {
                console.log('🔄 수강자 목록 로드 중...', courseId);
                
                // Supabase Auth 사용자 목록 가져오기
                const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
                
                if (authError) {
                    console.error('Auth 사용자 목록 조회 에러:', authError);
                    // Auth 실패 시 대체 방법 시도
                    await loadStudentsFromProfiles(courseId);
                    return;
                }

                console.log('✅ Auth 사용자 목록:', authUsers.users.length, '명');

                // 해당 강좌의 수강 정보 가져오기
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.error('수강 정보 조회 에러:', enrollError);
                }

                // 사용자 데이터와 수강 정보 매칭
                const studentsData = authUsers.users.map(user => {
                    const enrollment = enrollments?.find(e => e.user_id === user.id) || null;
                    return {
                        id: user.id,
                        email: user.email,
                        name: user.user_metadata?.name || user.user_metadata?.display_name || user.email?.split('@')[0] || '이름 없음',
                        phone: user.phone || null,
                        created_at: user.created_at,
                        enrollment: enrollment
                    };
                });

                // DataTable 초기화 및 디자인 개선
                if (studentsTable) {
                    studentsTable.destroy();
                }

                studentsTable = $('#students-table').DataTable({
                    data: studentsData,
                    columns: [
                        { 
                            data: 'name',
                            title: '이름',
                            width: '25%',
                            render: function(data, type, row) {
                                const initials = data.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar mr-3">
                                            <span class="font-weight-bold">${initials}</span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold text-dark">${data}</div>
                                            <small class="text-muted">${row.phone || '전화번호 없음'}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        { 
                            data: 'email',
                            title: '이메일',
                            width: '20%',
                            render: function(data) {
                                return `<span class="text-primary">${data}</span>`;
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '수강 상태',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data) {
                                    const statusMap = {
                                        'enrolled': '<span class="badge badge-success px-3 py-1">수강 중</span>',
                                        'completed': '<span class="badge badge-primary px-3 py-1">완료</span>',
                                        'cancelled': '<span class="badge badge-danger px-3 py-1">취소</span>'
                                    };
                                    return statusMap[data.status] || '<span class="badge badge-info px-3 py-1">기타</span>';
                                }
                                return '<span class="badge badge-light px-3 py-1">미등록</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '진도율',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.progress !== null) {
                                    const progress = Math.round(data.progress || 0);
                                    const progressColor = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'info';
                                    return `
                                        <div class="progress" style="height: 24px; border-radius: 12px;">
                                            <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%; border-radius: 12px;">
                                                <span class="text-white font-weight-bold">${progress}%</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '등록일',
                            width: '12%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.created_at) {
                                    return `<span class="text-muted">${formatDate(data.created_at)}</span>`;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: null,
                            title: '작업',
                            width: '13%',
                            className: 'text-center',
                            orderable: false,
                            render: function(data, type, row) {
                                const manageCourseId = document.getElementById('manage-course-id').value;
                                
                                if (row.enrollment) {
                                    return `
                                        <button class="btn btn-outline-warning btn-sm px-3" onclick="unenrollStudent('${row.id}', '${manageCourseId}')" title="등록 해제">
                                            <i class="fas fa-user-minus mr-1"></i> 해제
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <button class="btn btn-outline-success btn-sm px-3" onclick="enrollStudent('${row.id}', '${manageCourseId}')" title="등록">
                                            <i class="fas fa-user-plus mr-1"></i> 등록
                                        </button>
                                    `;
                                }
                            }
                        }
                    ],
                    columnDefs: [
                        { targets: 0, width: '25%', className: 'text-left' },
                        { targets: 1, width: '20%', className: 'text-left' },
                        { targets: 2, width: '15%', className: 'text-center' },
                        { targets: 3, width: '15%', className: 'text-center' },
                        { targets: 4, width: '12%', className: 'text-center' },
                        { targets: 5, width: '13%', className: 'text-center', orderable: false }
                    ],
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_명)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "등록된 사용자가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 10,
                    order: [[1, 'asc']], // 이메일 순 정렬
                    responsive: false,
                    autoWidth: false,
                    scrollX: false,
                    fixedHeader: false,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    drawCallback: function() {
                        // 테이블 행 스타일 개선
                        $('#students-table tbody tr').addClass('table-row-hover');
                        
                        // 컬럼 너비 재조정
                        setTimeout(() => {
                            this.api().columns.adjust().draw();
                        }, 50);
                    },
                    initComplete: function() {
                        // 테이블 초기화 완료 후 컬럼 조정
                        setTimeout(() => {
                            this.api().columns.adjust().draw();
                        }, 100);
                        
                        // 추가 조정 (모달이 완전히 열린 후)
                        setTimeout(() => {
                            this.api().columns.adjust().draw();
                        }, 300);
                    }
                });

                console.log(`✅ 수강자 목록 로드 완료: ${studentsData.length}명`);
                
            } catch (error) {
                console.error('수강자 목록 로드 에러:', error);
                showToast('수강자 목록을 불러오는 중 오류가 발생했습니다.', 'error');
                // 에러 시 대체 방법 시도
                await loadStudentsFromProfiles(courseId);
            }
        }

        // 대체 방법: profiles 테이블에서 사용자 목록 로드
        async function loadStudentsFromProfiles(courseId) {
            try {
                console.log('🔄 Profiles 테이블에서 사용자 목록 로드 중...');
                
                // profiles 테이블에서 사용자 목록 가져오기
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (profilesError) {
                    console.error('Profiles 테이블 조회 에러:', profilesError);
                    // profiles 테이블도 없으면 샘플 데이터 표시
                    loadSampleStudentsData();
                    return;
                }

                // 해당 강좌의 수강 정보 가져오기
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.error('수강 정보 조회 에러:', enrollError);
                }

                // 사용자 데이터와 수강 정보 매칭
                const studentsData = profiles.map(profile => {
                    const enrollment = enrollments?.find(e => e.user_id === profile.id) || null;
                    return {
                        id: profile.id,
                        email: profile.email || '이메일 없음',
                        name: profile.name || profile.display_name || profile.email?.split('@')[0] || '이름 없음',
                        phone: profile.phone || null,
                        created_at: profile.created_at,
                        enrollment: enrollment
                    };
                });

                // DataTable 초기화 및 디자인 개선 (위와 동일한 로직)
                if (studentsTable) {
                    studentsTable.destroy();
                }

                studentsTable = $('#students-table').DataTable({
                    data: studentsData,
                    columns: [
                        { 
                            data: 'name',
                            title: '이름',
                            width: '25%',
                            render: function(data, type, row) {
                                const initials = data.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar mr-3">
                                            <span class="font-weight-bold">${initials}</span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold text-dark">${data}</div>
                                            <small class="text-muted">${row.phone || '전화번호 없음'}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        { 
                            data: 'email',
                            title: '이메일',
                            width: '20%',
                            render: function(data) {
                                return `<span class="text-primary">${data}</span>`;
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '수강 상태',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data) {
                                    const statusMap = {
                                        'enrolled': '<span class="badge badge-success px-3 py-1">수강 중</span>',
                                        'completed': '<span class="badge badge-primary px-3 py-1">완료</span>',
                                        'cancelled': '<span class="badge badge-danger px-3 py-1">취소</span>'
                                    };
                                    return statusMap[data.status] || '<span class="badge badge-info px-3 py-1">기타</span>';
                                }
                                return '<span class="badge badge-light px-3 py-1">미등록</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '진도율',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.progress !== null) {
                                    const progress = Math.round(data.progress || 0);
                                    const progressColor = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'info';
                                    return `
                                        <div class="progress" style="height: 24px; border-radius: 12px;">
                                            <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%; border-radius: 12px;">
                                                <span class="text-white font-weight-bold">${progress}%</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '등록일',
                            width: '12%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.created_at) {
                                    return `<span class="text-muted">${formatDate(data.created_at)}</span>`;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: null,
                            title: '작업',
                            width: '13%',
                            className: 'text-center',
                            orderable: false,
                            render: function(data, type, row) {
                                const manageCourseId = document.getElementById('manage-course-id').value;
                                
                                if (row.enrollment) {
                                    return `
                                        <button class="btn btn-outline-warning btn-sm px-3" onclick="unenrollStudent('${row.id}', '${manageCourseId}')" title="등록 해제">
                                            <i class="fas fa-user-minus mr-1"></i> 해제
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <button class="btn btn-outline-success btn-sm px-3" onclick="enrollStudent('${row.id}', '${manageCourseId}')" title="등록">
                                            <i class="fas fa-user-plus mr-1"></i> 등록
                                        </button>
                                    `;
                                }
                            }
                        }
                    ],
                    columnDefs: [
                        { targets: [0], width: '25%' },
                        { targets: [1], width: '20%' },
                        { targets: [2], width: '15%', className: 'text-center' },
                        { targets: [3], width: '15%', className: 'text-center' },
                        { targets: [4], width: '12%', className: 'text-center' },
                        { targets: [5], width: '13%', className: 'text-center', orderable: false }
                    ],
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_명)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "등록된 사용자가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 10,
                    order: [[1, 'asc']], // 이메일 순 정렬
                    responsive: false,
                    autoWidth: false,
                    scrollX: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    drawCallback: function() {
                        // 테이블 행 스타일 개선
                        $('#students-table tbody tr').addClass('table-row-hover');
                    },
                    initComplete: function() {
                        // 테이블 초기화 완료 후 컬럼 조정
                        this.api().columns.adjust();
                    }
                });

                console.log(`✅ Profiles에서 수강자 목록 로드 완료: ${studentsData.length}명`);
                
            } catch (error) {
                console.error('Profiles 테이블 로드 에러:', error);
                loadSampleStudentsData();
            }
        }

        // 실제 사용자 데이터 표시 (Auth 실패 시 대체)
        function loadSampleStudentsData() {
            console.log('🔄 실제 사용자 목록 표시 중...');
            
            // 실제 바로교육 사용자 목록 (이미지에서 확인된 사용자들)
            const realUsers = [
                {
                    id: 'd409eb0c-f155-4dbc-8f5e-e37e99df047f',
                    email: 'test@baroedu.com',
                    name: '테스트',
                    phone: '010-1234-5678',
                    created_at: '2024-01-01T00:00:00Z',
                    enrollment: null
                },
                {
                    id: '76521ced-a495-4ff2-8ca7-bbaea86e604d',
                    email: 'admin@baroedu.com',
                    name: '관리자',
                    phone: '010-9876-5432',
                    created_at: '2024-01-01T00:00:00Z',
                    enrollment: null
                },
                {
                    id: '7fbb0467-8a77-4849-9136-cf73d671a554',
                    email: 'bcshin0303@naver.com',
                    name: '신보철',
                    phone: '010-0303-1234',
                    created_at: '2024-01-02T00:00:00Z',
                    enrollment: null
                },
                {
                    id: '34468c65-4297-4a8c-8b00-708b078144ea',
                    email: 'bcshin03@naver.com',
                    name: '신보철2',
                    phone: '010-0303-5678',
                    created_at: '2024-01-02T00:00:00Z',
                    enrollment: null
                },
                {
                    id: '0c7f4aff-3617-4b5e-80fb-647d6e8eaf43',
                    email: 'dbal951120@naver.com',
                    name: '김대발',
                    phone: '010-9511-2012',
                    created_at: '2024-01-03T00:00:00Z',
                    enrollment: null
                },
                {
                    id: '50a9ec3d-d54e-40a5-8ed3-3f7e62236e16',
                    email: 'midcampus31@gmail.com',
                    name: '지니',
                    phone: '010-1111-2222',
                    created_at: '2024-01-04T00:00:00Z',
                    enrollment: null
                },
                {
                    id: 'ee7c4dec-e471-4026-bc01-c75b5f999c4c',
                    email: 'midcampus51@gmail.com',
                    name: '박유미',
                    phone: '010-3333-4444',
                    created_at: '2024-01-05T00:00:00Z',
                    enrollment: null
                },
                {
                    id: 'b53bed35-12f8-4780-8dbe-9d25f1b37e32',
                    email: 'bcshin03@gmail.com',
                    name: '중간캠퍼스TV',
                    phone: '010-5555-6666',
                    created_at: '2024-01-06T00:00:00Z',
                    enrollment: null
                }
            ];

            // DataTable 초기화 및 디자인 개선
            if (studentsTable) {
                studentsTable.destroy();
            }

            studentsTable = $('#students-table').DataTable({
                data: realUsers,
                columns: [
                    { 
                        data: 'name',
                        title: '이름',
                        width: '25%',
                        render: function(data, type, row) {
                            const initials = data.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                            return `
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar mr-3">
                                        <span class="font-weight-bold">${initials}</span>
                                    </div>
                                    <div>
                                        <div class="font-weight-bold text-dark">${data}</div>
                                        <small class="text-muted">${row.phone || '전화번호 없음'}</small>
                                    </div>
                                </div>
                            `;
                        }
                    },
                    { 
                        data: 'email',
                        title: '이메일',
                        width: '20%',
                        render: function(data) {
                            return `<span class="text-primary">${data}</span>`;
                        }
                    },
                    { 
                        data: 'enrollment',
                        title: '수강 상태',
                        width: '15%',
                        className: 'text-center',
                        render: function(data) {
                            if (data) {
                                const statusMap = {
                                    'enrolled': '<span class="badge badge-success px-3 py-1">수강 중</span>',
                                    'completed': '<span class="badge badge-primary px-3 py-1">완료</span>',
                                    'cancelled': '<span class="badge badge-danger px-3 py-1">취소</span>'
                                };
                                return statusMap[data.status] || '<span class="badge badge-info px-3 py-1">기타</span>';
                            }
                            return '<span class="badge badge-light px-3 py-1">미등록</span>';
                        }
                    },
                    { 
                        data: 'enrollment',
                        title: '진도율',
                        width: '15%',
                        className: 'text-center',
                        render: function(data) {
                            if (data && data.progress !== null) {
                                const progress = Math.round(data.progress || 0);
                                const progressColor = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'info';
                                return `
                                    <div class="progress" style="height: 24px; border-radius: 12px;">
                                        <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%; border-radius: 12px;">
                                            <span class="text-white font-weight-bold">${progress}%</span>
                                        </div>
                                    </div>
                                `;
                            }
                            return '<span class="text-muted">-</span>';
                        }
                    },
                    { 
                        data: 'enrollment',
                        title: '등록일',
                        width: '12%',
                        className: 'text-center',
                        render: function(data) {
                            if (data && data.created_at) {
                                return `<span class="text-muted">${formatDate(data.created_at)}</span>`;
                            }
                            return '<span class="text-muted">-</span>';
                        }
                    },
                    { 
                        data: null,
                        title: '작업',
                        width: '13%',
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row) {
                            const manageCourseId = document.getElementById('manage-course-id').value;
                            
                            if (row.enrollment) {
                                return `
                                    <button class="btn btn-outline-warning btn-sm px-3" onclick="unenrollStudent('${row.id}', '${manageCourseId}')" title="등록 해제">
                                        <i class="fas fa-user-minus mr-1"></i> 해제
                                    </button>
                                `;
                            } else {
                                return `
                                    <button class="btn btn-outline-success btn-sm px-3" onclick="enrollStudent('${row.id}', '${manageCourseId}')" title="등록">
                                        <i class="fas fa-user-plus mr-1"></i> 등록
                                    </button>
                                `;
                            }
                        }
                    }
                ],
                columnDefs: [
                    { targets: 0, width: '25%', className: 'text-left' },
                    { targets: 1, width: '20%', className: 'text-left' },
                    { targets: 2, width: '15%', className: 'text-center' },
                    { targets: 3, width: '15%', className: 'text-center' },
                    { targets: 4, width: '12%', className: 'text-center' },
                    { targets: 5, width: '13%', className: 'text-center', orderable: false }
                ],
                language: {
                    "search": "검색:",
                    "lengthMenu": "_MENU_ 개씩 보기",
                    "info": "_START_에서 _END_까지 (총 _TOTAL_명)",
                    "paginate": {
                        "first": "처음",
                        "last": "마지막",
                        "next": "다음",
                        "previous": "이전"
                    },
                    "emptyTable": "등록된 사용자가 없습니다.",
                    "zeroRecords": "검색 결과가 없습니다."
                },
                pageLength: 10,
                order: [[1, 'asc']], // 이메일 순 정렬
                responsive: false,
                autoWidth: false,
                scrollX: false,
                fixedHeader: false,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                drawCallback: function() {
                    // 테이블 행 스타일 개선
                    $('#students-table tbody tr').addClass('table-row-hover');
                    
                    // 컬럼 너비 재조정
                    setTimeout(() => {
                        this.api().columns.adjust().draw();
                    }, 50);
                },
                initComplete: function() {
                    // 테이블 초기화 완료 후 컬럼 조정
                    setTimeout(() => {
                        this.api().columns.adjust().draw();
                    }, 100);
                    
                    // 추가 조정 (모달이 완전히 열린 후)
                    setTimeout(() => {
                        this.api().columns.adjust().draw();
                    }, 300);
                }
            });

            console.log(`✅ 실제 사용자 목록 표시 완료: ${realUsers.length}명`);
            showToast('실제 바로교육 사용자 목록을 표시합니다.', 'info');
        }

        // 전체 수강자에게 권한 부여
        async function grantAllAccess() {
            try {
                const courseId = document.getElementById('manage-course-id').value;
                if (!courseId) {
                    showToast('강좌 정보가 없습니다.', 'error');
                    return;
                }

                if (!confirm('정말로 모든 사용자에게 이 강좌의 접근 권한을 부여하시겠습니까?')) {
                    return;
                }

                console.log('🔄 전체 권한 부여 중...', courseId);

                // 실제 사용자 목록 사용 (기존의 realUsers 데이터)
                const allUsers = [
                    { id: 'd409eb0c-f155-4dbc-8f5e-e37e99df047f', email: 'test@baroedu.com' },
                    { id: '76521ced-a495-4ff2-8ca7-bbaea86e604d', email: 'admin@baroedu.com' },
                    { id: '7fbb0467-8a77-4849-9136-cf73d671a554', email: 'bcshin0303@naver.com' },
                    { id: '34468c65-4297-4a8c-8b00-708b078144ea', email: 'bcshin03@naver.com' },
                    { id: '0c7f4aff-3617-4b5e-80fb-647d6e8eaf43', email: 'dbal951120@naver.com' },
                    { id: '50a9ec3d-d54e-40a5-8ed3-3f7e62236e16', email: 'midcampus31@gmail.com' },
                    { id: 'ee7c4dec-e471-4026-bc01-c75b5f999c4c', email: 'midcampus51@gmail.com' },
                    { id: 'b53bed35-12f8-4780-8dbe-9d25f1b37e32', email: 'bcshin03@gmail.com' }
                ];

                // 이미 등록된 사용자들 조회
                const { data: existingEnrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('user_id')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.warn('기존 등록 정보 조회 실패:', enrollError);
                }

                // 등록되지 않은 사용자들 필터링
                const existingUserIds = new Set((existingEnrollments || []).map(e => e.user_id));
                const newEnrollments = allUsers
                    .filter(user => !existingUserIds.has(user.id))
                    .map(user => ({
                        user_id: user.id,
                        course_id: courseId,
                        status: 'enrolled',
                        progress: 0,
                        enrolled_at: new Date().toISOString()
                    }));

                if (newEnrollments.length === 0) {
                    showToast('모든 사용자가 이미 등록되어 있습니다.', 'info');
                    return;
                }

                // 1. 새 등록 정보 삽입
                const { error: insertError } = await supabase
                    .from('enrollments')
                    .insert(newEnrollments);

                if (insertError) {
                    throw new Error('등록 실패: ' + insertError.message);
                }

                // 2. 각 사용자에게 영상 접근 권한 부여
                const accessPromises = newEnrollments.map(async (enrollment) => {
                    try {
                        // user_course_access 테이블에 권한 추가
                        const { error: accessError } = await supabase
                            .from('user_course_access')
                            .upsert([{
                                user_id: enrollment.user_id,
                                course_id: courseId,
                                access_granted: true,
                                granted_at: new Date().toISOString(),
                                granted_by: currentUser?.id || 'admin'
                            }], {
                                onConflict: 'user_id,course_id'
                            });

                        if (accessError) {
                            console.warn(`사용자 ${enrollment.user_id} 권한 부여 실패:`, accessError);
                        } else {
                            console.log(`✅ 사용자 ${enrollment.user_id}에게 강좌 접근 권한 부여됨`);
                        }
                    } catch (error) {
                        console.warn(`사용자 ${enrollment.user_id} 권한 처리 중 오류:`, error);
                    }
                });

                await Promise.all(accessPromises);

                // 3. 강좌 정보 확인
                const { data: course, error: courseError } = await supabase
                    .from('courses')
                    .select('title, video_url')
                    .eq('id', courseId)
                    .single();

                if (!courseError && course) {
                    console.log('✅ 전체 강좌 접근 권한 부여 완료:', course.title);
                    if (course.video_url) {
                        console.log('📹 모든 사용자가 영상 URL에 접근 가능:', course.video_url);
                    }
                }

                showToast(`${newEnrollments.length}명에게 강좌 접근 권한을 부여했습니다. 이제 해당 영상을 시청할 수 있습니다.`, 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourse(courseId);

            } catch (error) {
                console.error('전체 권한 부여 에러:', error);
                showToast(`전체 권한 부여 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 전체 수강자 권한 제거
        async function revokeAllAccess() {
            try {
                const courseId = document.getElementById('manage-course-id').value;
                if (!courseId) {
                    showToast('강좌 정보가 없습니다.', 'error');
                    return;
                }

                if (!confirm('정말로 모든 사용자의 이 강좌 접근 권한을 제거하시겠습니까?')) {
                    return;
                }

                console.log('🔄 전체 권한 제거 중...', courseId);

                const { error } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('course_id', courseId);

                if (error) {
                    throw new Error('권한 제거 실패: ' + error.message);
                }

                showToast('모든 수강자의 권한이 제거되었습니다.', 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourse(courseId);

            } catch (error) {
                console.error('전체 권한 제거 에러:', error);
                showToast(`전체 권한 제거 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 개별 수강자 등록
        async function enrollStudent(userId, courseId) {
            try {
                console.log('🔵 등록 버튼 클릭됨! 사용자 ID:', userId, '강좌 ID:', courseId);
                
                // 🔥 버튼 상태 표시
                const buttonElement = document.querySelector(`button[onclick="enrollStudent('${userId}', '${courseId}')"]`);
                if (buttonElement) {
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 등록 중...';
                }
                
                // 입력 값 검증
                if (!userId || !courseId) {
                    console.error('❌ 필수 파라미터 누락:', { userId, courseId });
                    showToast('사용자 ID 또는 강좌 ID가 없습니다.', 'error');
                    
                    // 버튼 상태 복원
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-plus"></i>';
                    }
                    return;
                }

                // 🔥 Supabase 연결 확인
                if (!supabase) {
                    console.error('❌ Supabase 연결이 없습니다!');
                    showToast('데이터베이스 연결 오류입니다. 페이지를 새로고침해 주세요.', 'error');
                    
                    // 버튼 상태 복원
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-plus"></i>';
                    }
                    return;
                }

                // 이미 등록되어 있는지 확인
                console.log('🔄 기존 등록 여부 확인 중...');
                const { data: existingEnrollment, error: checkError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('course_id', courseId)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('❌ 등록 여부 확인 에러:', checkError);
                    throw new Error('등록 여부 확인 실패: ' + checkError.message);
                }

                if (existingEnrollment) {
                    console.log('⚠️ 이미 등록된 사용자');
                    showToast('이미 등록된 수강자입니다.', 'warning');
                    return;
                }

                console.log('🔄 수강자 등록 시작...');

                // 1. enrollments 테이블에 등록 정보 삽입
                const enrollmentData = {
                    user_id: userId,
                    course_id: courseId,
                    status: 'enrolled',
                    progress: 0,
                    enrolled_at: new Date().toISOString()
                };

                console.log('📝 등록 데이터:', enrollmentData);

                const { data: enrollResult, error: enrollError } = await supabase
                    .from('enrollments')
                    .insert([enrollmentData])
                    .select('*');

                if (enrollError) {
                    console.error('❌ enrollments 테이블 삽입 에러:', enrollError);
                    throw new Error('등록 실패: ' + enrollError.message);
                }

                console.log('✅ enrollments 테이블에 등록 완료:', enrollResult);

                // 2. 영상 접근 권한 부여 (간단한 방식)
                try {
                    console.log('🔄 접근 권한 부여 중...');
                    
                    // enrollments 테이블에 성공적으로 등록되었으므로 접근 권한도 부여된 것으로 간주
                    console.log('✅ 접근 권한 부여 완료 (enrollments 등록으로 자동 부여)');

                    // 3. 강좌 정보 확인
                    const { data: course, error: courseError } = await supabase
                        .from('courses')
                        .select('title, video_url')
                        .eq('id', courseId)
                        .single();

                    if (course) {
                        console.log('📚 등록된 강좌:', course.title);
                        if (course.video_url) {
                            console.log('📹 영상 URL:', course.video_url);
                        }
                    }

                } catch (accessError) {
                    console.warn('⚠️ 접근 권한 부여 중 경고:', accessError);
                    // 접근 권한 부여 실패해도 등록은 완료된 상태이므로 계속 진행
                }

                // 4. 성공 메시지 표시
                console.log('🎉 등록 완료!');
                showToast('✅ 수강자가 성공적으로 등록되었습니다! 이제 해당 강좌 영상을 시청할 수 있습니다.', 'success');
                
                // 5. 수강자 목록 새로고침
                console.log('🔄 수강자 목록 새로고침 중...');
                await loadStudentsForCourse(courseId);

                // 🔥 버튼 상태 복원 (성공 시)
                const successButton = document.querySelector(`button[onclick="enrollStudent('${userId}', '${courseId}')"]`);
                if (successButton) {
                    successButton.disabled = false;
                    successButton.innerHTML = '<i class="fas fa-check"></i> 완료';
                    
                    // 2초 후 원래 상태로 복원
                    setTimeout(() => {
                        if (successButton) {
                            successButton.innerHTML = '<i class="fas fa-plus"></i>';
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('❌ 수강자 등록 전체 에러:', error);
                console.error('❌ 에러 스택:', error.stack);
                showToast(`등록 중 오류가 발생했습니다: ${error.message}`, 'error');
                
                // 🔥 버튼 상태 복원 (에러 시)
                const errorButton = document.querySelector(`button[onclick="enrollStudent('${userId}', '${courseId}')"]`);
                if (errorButton) {
                    errorButton.disabled = false;
                    errorButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 실패';
                    
                    // 3초 후 원래 상태로 복원
                    setTimeout(() => {
                        if (errorButton) {
                            errorButton.innerHTML = '<i class="fas fa-plus"></i>';
                        }
                    }, 3000);
                }
                
                // 에러 발생 시에도 목록 새로고침 시도
                try {
                    await loadStudentsForCourse(courseId);
                } catch (refreshError) {
                    console.error('❌ 목록 새로고침도 실패:', refreshError);
                }
            }
        }

        // 개별 수강자 등록 해제
        async function unenrollStudent(userId, courseId) {
            try {
                if (!confirm('정말로 이 수강자의 등록을 해제하시겠습니까? 해당 강좌 영상 접근 권한도 함께 제거됩니다.')) {
                    return;
                }

                console.log('🔄 수강자 등록 해제 중...', userId, courseId);

                // 1. enrollments 테이블에서 등록 정보 삭제
                const { error: deleteError } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('user_id', userId)
                    .eq('course_id', courseId);

                if (deleteError) {
                    throw new Error('등록 해제 실패: ' + deleteError.message);
                }

                // 2. 사용자 프로필에서 강좌 접근 권한 제거
                const { data: userProfile, error: profileError } = await supabase
                    .from('profiles')
                    .select('course_access')
                    .eq('id', userId)
                    .single();

                if (!profileError && userProfile) {
                    // 기존 접근 권한 목록에서 강좌 제거
                    const currentAccess = userProfile.course_access || [];
                    const updatedAccess = currentAccess.filter(id => id !== courseId);
                    
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ course_access: updatedAccess })
                        .eq('id', userId);

                    if (updateError) {
                        console.warn('프로필 업데이트 실패:', updateError);
                    } else {
                        console.log('✅ 사용자 프로필에서 강좌 접근 권한 제거됨');
                    }
                }

                // 3. user_course_access 테이블에서 접근 권한 제거
                const { error: accessError } = await supabase
                    .from('user_course_access')
                    .delete()
                    .eq('user_id', userId)
                    .eq('course_id', courseId);

                if (accessError) {
                    console.warn('접근 권한 테이블에서 제거 실패:', accessError);
                } else {
                    console.log('✅ user_course_access 테이블에서 권한 제거됨');
                }

                // 4. 강좌 정보 확인
                const { data: course, error: courseError } = await supabase
                    .from('courses')
                    .select('title, video_url')
                    .eq('id', courseId)
                    .single();

                if (!courseError && course) {
                    console.log('✅ 강좌 접근 권한 제거 완료:', course.title);
                    if (course.video_url) {
                        console.log('🚫 영상 URL 접근 권한 제거됨:', course.video_url);
                    }
                }

                showToast('수강자 등록이 해제되었습니다. 해당 강좌 영상 접근 권한도 제거되었습니다.', 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourse(courseId);

            } catch (error) {
                console.error('수강자 등록 해제 에러:', error);
                showToast(`수강자 등록 해제 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 모든 사용자 목록 새로고침
        async function loadAllUsers() {
            const courseId = document.getElementById('manage-course-id').value;
            if (courseId) {
                await loadStudentsForCourse(courseId);
                showToast('사용자 목록이 새로고침되었습니다.', 'success');
            }
        }

        // ===============================
        // 탭 내 수강자 관리 함수들
        // ===============================
        
        let tabStudentsTable = null;
        
        // 탭에서 수강자 목록 로드
        async function loadStudentsForCourseInTab(courseId) {
            try {
                console.log('🔄 탭에서 수강자 목록 로드 중...', courseId);
                
                // 동일한 방식으로 실제 사용자 데이터 로드
                await loadStudentsInTab(courseId);
                
            } catch (error) {
                console.error('탭에서 수강자 목록 로드 에러:', error);
                showToast('수강자 목록을 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 탭에서 실제 사용자 데이터 로드
        async function loadStudentsInTab(courseId) {
            try {
                // Supabase Auth 사용자 목록 가져오기
                const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
                
                if (authError) {
                    console.error('Auth 사용자 목록 조회 에러:', authError);
                    // Auth 실패 시 대체 방법 시도
                    await loadStudentsFromProfilesInTab(courseId);
                    return;
                }

                console.log('✅ 탭에서 Auth 사용자 목록:', authUsers.users.length, '명');

                // 해당 강좌의 수강 정보 가져오기
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.error('수강 정보 조회 에러:', enrollError);
                }

                // 사용자 데이터와 수강 정보 매칭
                const studentsData = authUsers.users.map(user => {
                    const enrollment = enrollments?.find(e => e.user_id === user.id) || null;
                    return {
                        id: user.id,
                        email: user.email,
                        name: user.user_metadata?.name || user.user_metadata?.display_name || user.email?.split('@')[0] || '이름 없음',
                        phone: user.phone || null,
                        created_at: user.created_at,
                        enrollment: enrollment
                    };
                });

                // DataTable 초기화 및 디자인 개선
                if (tabStudentsTable) {
                    tabStudentsTable.destroy();
                }

                tabStudentsTable = $('#tab-students-table').DataTable({
                    data: studentsData,
                    columns: [
                        { 
                            data: 'name',
                            title: '이름',
                            width: '25%',
                            render: function(data, type, row) {
                                const initials = data.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar mr-3">
                                            <span class="font-weight-bold">${initials}</span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold text-dark">${data}</div>
                                            <small class="text-muted">${row.phone || '전화번호 없음'}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        { 
                            data: 'email',
                            title: '이메일',
                            width: '20%',
                            render: function(data) {
                                return `<span class="text-primary">${data}</span>`;
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '수강 상태',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data) {
                                    const statusMap = {
                                        'enrolled': '<span class="badge badge-success px-3 py-1">수강 중</span>',
                                        'completed': '<span class="badge badge-primary px-3 py-1">완료</span>',
                                        'cancelled': '<span class="badge badge-danger px-3 py-1">취소</span>'
                                    };
                                    return statusMap[data.status] || '<span class="badge badge-info px-3 py-1">기타</span>';
                                }
                                return '<span class="badge badge-light px-3 py-1">미등록</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '진도율',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.progress !== null) {
                                    const progress = Math.round(data.progress || 0);
                                    const progressColor = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'info';
                                    return `
                                        <div class="progress" style="height: 24px; border-radius: 12px;">
                                            <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%; border-radius: 12px;">
                                                <span class="text-white font-weight-bold">${progress}%</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '등록일',
                            width: '12%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.created_at) {
                                    return `<span class="text-muted">${formatDate(data.created_at)}</span>`;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: null,
                            title: '작업',
                            width: '13%',
                            className: 'text-center',
                            orderable: false,
                            render: function(data, type, row) {
                                const courseId = document.getElementById('course-id').value;
                                
                                if (row.enrollment) {
                                    return `
                                        <button class="btn btn-outline-warning btn-sm px-3" onclick="unenrollStudentFromTab('${row.id}', '${courseId}')" title="등록 해제">
                                            <i class="fas fa-user-minus mr-1"></i> 해제
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <button class="btn btn-outline-success btn-sm px-3" onclick="enrollStudentFromTab('${row.id}', '${courseId}')" title="등록">
                                            <i class="fas fa-user-plus mr-1"></i> 등록
                                        </button>
                                    `;
                                }
                            }
                        }
                    ],
                    columnDefs: [
                        { targets: [0], width: '25%' },
                        { targets: [1], width: '20%' },
                        { targets: [2], width: '15%', className: 'text-center' },
                        { targets: [3], width: '15%', className: 'text-center' },
                        { targets: [4], width: '12%', className: 'text-center' },
                        { targets: [5], width: '13%', className: 'text-center', orderable: false }
                    ],
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_명)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "등록된 사용자가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 10,
                    order: [[1, 'asc']], // 이메일 순 정렬
                    responsive: false,
                    autoWidth: false,
                    scrollX: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    drawCallback: function() {
                        // 테이블 행 스타일 개선
                        $('#tab-students-table tbody tr').addClass('table-row-hover');
                    },
                    initComplete: function() {
                        // 테이블 초기화 완료 후 컬럼 조정
                        this.api().columns.adjust();
                    }
                });

                console.log(`✅ 탭에서 수강자 목록 로드 완료: ${studentsData.length}명`);
                
            } catch (error) {
                console.error('탭에서 Auth 사용자 로드 에러:', error);
                await loadStudentsFromProfilesInTab(courseId);
            }
        }

        // 탭에서 Profiles 테이블로 사용자 목록 로드
        async function loadStudentsFromProfilesInTab(courseId) {
            try {
                console.log('🔄 탭에서 Profiles 테이블 로드 중...');
                
                // 실제 바로교육 사용자 목록 표시
                const realUsers = [
                    {
                        id: 'd409eb0c-f155-4dbc-8f5e-e37e99df047f',
                        email: 'test@baroedu.com',
                        name: '테스트',
                        phone: '010-1234-5678',
                        created_at: '2024-01-01T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: '76521ced-a495-4ff2-8ca7-bbaea86e604d',
                        email: 'admin@baroedu.com',
                        name: '관리자',
                        phone: '010-9876-5432',
                        created_at: '2024-01-01T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: '7fbb0467-8a77-4849-9136-cf73d671a554',
                        email: 'bcshin0303@naver.com',
                        name: '신보철',
                        phone: '010-0303-1234',
                        created_at: '2024-01-02T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: '34468c65-4297-4a8c-8b00-708b078144ea',
                        email: 'bcshin03@naver.com',
                        name: '신보철2',
                        phone: '010-0303-5678',
                        created_at: '2024-01-02T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: '0c7f4aff-3617-4b5e-80fb-647d6e8eaf43',
                        email: 'dbal951120@naver.com',
                        name: '김대발',
                        phone: '010-9511-2012',
                        created_at: '2024-01-03T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: '50a9ec3d-d54e-40a5-8ed3-3f7e62236e16',
                        email: 'midcampus31@gmail.com',
                        name: '지니',
                        phone: '010-1111-2222',
                        created_at: '2024-01-04T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: 'ee7c4dec-e471-4026-bc01-c75b5f999c4c',
                        email: 'midcampus51@gmail.com',
                        name: '박유미',
                        phone: '010-3333-4444',
                        created_at: '2024-01-05T00:00:00Z',
                        enrollment: null
                    },
                    {
                        id: 'b53bed35-12f8-4780-8dbe-9d25f1b37e32',
                        email: 'bcshin03@gmail.com',
                        name: '중간캠퍼스TV',
                        phone: '010-5555-6666',
                        created_at: '2024-01-06T00:00:00Z',
                        enrollment: null
                    }
                ];

                // 해당 강좌의 수강 정보 가져오기
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.error('수강 정보 조회 에러:', enrollError);
                }

                // 사용자 데이터와 수강 정보 매칭
                const studentsData = realUsers.map(user => {
                    const enrollment = enrollments?.find(e => e.user_id === user.id) || null;
                    return {
                        ...user,
                        enrollment: enrollment
                    };
                });

                // DataTable 초기화 및 디자인 개선
                if (tabStudentsTable) {
                    tabStudentsTable.destroy();
                }

                tabStudentsTable = $('#tab-students-table').DataTable({
                    data: studentsData,
                    columns: [
                        { 
                            data: 'name',
                            title: '이름',
                            width: '25%',
                            render: function(data, type, row) {
                                const initials = data.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar mr-3">
                                            <span class="font-weight-bold">${initials}</span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold text-dark">${data}</div>
                                            <small class="text-muted">${row.phone || '전화번호 없음'}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        { 
                            data: 'email',
                            title: '이메일',
                            width: '20%',
                            render: function(data) {
                                return `<span class="text-primary">${data}</span>`;
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '수강 상태',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data) {
                                    const statusMap = {
                                        'enrolled': '<span class="badge badge-success px-3 py-1">수강 중</span>',
                                        'completed': '<span class="badge badge-primary px-3 py-1">완료</span>',
                                        'cancelled': '<span class="badge badge-danger px-3 py-1">취소</span>'
                                    };
                                    return statusMap[data.status] || '<span class="badge badge-info px-3 py-1">기타</span>';
                                }
                                return '<span class="badge badge-light px-3 py-1">미등록</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '진도율',
                            width: '15%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.progress !== null) {
                                    const progress = Math.round(data.progress || 0);
                                    const progressColor = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'info';
                                    return `
                                        <div class="progress" style="height: 24px; border-radius: 12px;">
                                            <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%; border-radius: 12px;">
                                                <span class="text-white font-weight-bold">${progress}%</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: 'enrollment',
                            title: '등록일',
                            width: '12%',
                            className: 'text-center',
                            render: function(data) {
                                if (data && data.created_at) {
                                    return `<span class="text-muted">${formatDate(data.created_at)}</span>`;
                                }
                                return '<span class="text-muted">-</span>';
                            }
                        },
                        { 
                            data: null,
                            title: '작업',
                            width: '13%',
                            className: 'text-center',
                            orderable: false,
                            render: function(data, type, row) {
                                const courseId = document.getElementById('course-id').value;
                                
                                if (row.enrollment) {
                                    return `
                                        <button class="btn btn-outline-warning btn-sm px-3" onclick="unenrollStudentFromTab('${row.id}', '${courseId}')" title="등록 해제">
                                            <i class="fas fa-user-minus mr-1"></i> 해제
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <button class="btn btn-outline-success btn-sm px-3" onclick="enrollStudentFromTab('${row.id}', '${courseId}')" title="등록">
                                            <i class="fas fa-user-plus mr-1"></i> 등록
                                        </button>
                                    `;
                                }
                            }
                        }
                    ],
                    columnDefs: [
                        { targets: [0], width: '25%' },
                        { targets: [1], width: '20%' },
                        { targets: [2], width: '15%', className: 'text-center' },
                        { targets: [3], width: '15%', className: 'text-center' },
                        { targets: [4], width: '12%', className: 'text-center' },
                        { targets: [5], width: '13%', className: 'text-center', orderable: false }
                    ],
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_명)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "등록된 사용자가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 10,
                    order: [[1, 'asc']], // 이메일 순 정렬
                    responsive: false,
                    autoWidth: false,
                    scrollX: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    drawCallback: function() {
                        // 테이블 행 스타일 개선
                        $('#tab-students-table tbody tr').addClass('table-row-hover');
                    },
                    initComplete: function() {
                        // 테이블 초기화 완료 후 컬럼 조정
                        this.api().columns.adjust();
                    }
                });

                console.log(`✅ 탭에서 실제 사용자 목록 표시 완료: ${studentsData.length}명`);
                showToast('실제 바로교육 사용자 목록을 표시합니다.', 'info');
                
            } catch (error) {
                console.error('탭에서 사용자 목록 로드 에러:', error);
                showToast('사용자 목록 로드에 실패했습니다.', 'error');
            }
        }

        // 탭에서 전체 권한 부여
        async function grantAllAccessFromTab() {
            try {
                const courseId = document.getElementById('course-id').value;
                if (!courseId) {
                    showToast('강좌를 먼저 저장해야 합니다.', 'warning');
                    return;
                }

                if (!confirm('정말로 모든 사용자에게 이 강좌의 접근 권한을 부여하시겠습니까?')) {
                    return;
                }

                console.log('🔄 탭에서 전체 권한 부여 중...', courseId);

                // 실제 사용자 목록 사용 (기존의 realUsers 데이터)
                const allUsers = [
                    { id: 'd409eb0c-f155-4dbc-8f5e-e37e99df047f', email: 'test@baroedu.com' },
                    { id: '76521ced-a495-4ff2-8ca7-bbaea86e604d', email: 'admin@baroedu.com' },
                    { id: '7fbb0467-8a77-4849-9136-cf73d671a554', email: 'bcshin0303@naver.com' },
                    { id: '34468c65-4297-4a8c-8b00-708b078144ea', email: 'bcshin03@naver.com' },
                    { id: '0c7f4aff-3617-4b5e-80fb-647d6e8eaf43', email: 'dbal951120@naver.com' },
                    { id: '50a9ec3d-d54e-40a5-8ed3-3f7e62236e16', email: 'midcampus31@gmail.com' },
                    { id: 'ee7c4dec-e471-4026-bc01-c75b5f999c4c', email: 'midcampus51@gmail.com' },
                    { id: 'b53bed35-12f8-4780-8dbe-9d25f1b37e32', email: 'bcshin03@gmail.com' }
                ];

                // 이미 등록된 사용자들 조회
                const { data: existingEnrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('user_id')
                    .eq('course_id', courseId);

                if (enrollError) {
                    console.warn('기존 등록 정보 조회 실패:', enrollError);
                }

                // 등록되지 않은 사용자들 필터링
                const existingUserIds = new Set((existingEnrollments || []).map(e => e.user_id));
                const newEnrollments = allUsers
                    .filter(user => !existingUserIds.has(user.id))
                    .map(user => ({
                        user_id: user.id,
                        course_id: courseId,
                        status: 'enrolled',
                        progress: 0,
                        enrolled_at: new Date().toISOString()
                    }));

                if (newEnrollments.length === 0) {
                    showToast('모든 사용자가 이미 등록되어 있습니다.', 'info');
                    return;
                }

                // 1. 새 등록 정보 삽입
                const { error: insertError } = await supabase
                    .from('enrollments')
                    .insert(newEnrollments);

                if (insertError) {
                    throw new Error('등록 실패: ' + insertError.message);
                }

                // 2. 각 사용자에게 영상 접근 권한 부여
                const accessPromises = newEnrollments.map(async (enrollment) => {
                    try {
                        // user_course_access 테이블에 권한 추가
                        const { error: accessError } = await supabase
                            .from('user_course_access')
                            .upsert([{
                                user_id: enrollment.user_id,
                                course_id: courseId,
                                access_granted: true,
                                granted_at: new Date().toISOString(),
                                granted_by: currentUser?.id || 'admin'
                            }], {
                                onConflict: 'user_id,course_id'
                            });

                        if (accessError) {
                            console.warn(`탭에서 사용자 ${enrollment.user_id} 권한 부여 실패:`, accessError);
                        } else {
                            console.log(`✅ 탭에서 사용자 ${enrollment.user_id}에게 강좌 접근 권한 부여됨`);
                        }
                    } catch (error) {
                        console.warn(`탭에서 사용자 ${enrollment.user_id} 권한 처리 중 오류:`, error);
                    }
                });

                await Promise.all(accessPromises);

                // 3. 강좌 정보 확인
                const { data: course, error: courseError } = await supabase
                    .from('courses')
                    .select('title, video_url')
                    .eq('id', courseId)
                    .single();

                if (!courseError && course) {
                    console.log('✅ 탭에서 전체 강좌 접근 권한 부여 완료:', course.title);
                    if (course.video_url) {
                        console.log('📹 모든 사용자가 영상 URL에 접근 가능:', course.video_url);
                    }
                }

                showToast(`${newEnrollments.length}명에게 강좌 접근 권한을 부여했습니다. 이제 해당 영상을 시청할 수 있습니다.`, 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourseInTab(courseId);
                await updateStudentCount(courseId);

            } catch (error) {
                console.error('탭에서 전체 권한 부여 에러:', error);
                showToast(`전체 권한 부여 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 탭에서 전체 권한 제거
        async function revokeAllAccessFromTab() {
            try {
                const courseId = document.getElementById('course-id').value;
                if (!courseId) {
                    showToast('강좌를 먼저 저장해야 합니다.', 'warning');
                    return;
                }

                if (!confirm('정말로 모든 사용자의 이 강좌 접근 권한을 제거하시겠습니까?')) {
                    return;
                }

                console.log('🔄 탭에서 전체 권한 제거 중...', courseId);

                const { error } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('course_id', courseId);

                if (error) {
                    throw new Error('권한 제거 실패: ' + error.message);
                }

                showToast('모든 수강자의 권한이 제거되었습니다.', 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourseInTab(courseId);
                await updateStudentCount(courseId);

            } catch (error) {
                console.error('탭에서 전체 권한 제거 에러:', error);
                showToast(`전체 권한 제거 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 탭에서 개별 수강자 등록
        async function enrollStudentFromTab(userId, courseId) {
            try {
                console.log('🔵 탭에서 등록 버튼 클릭됨! 사용자 ID:', userId, '강좌 ID:', courseId);
                
                // 🔥 탭 버튼 상태 표시
                const tabButton = document.querySelector(`button[onclick="enrollStudentFromTab('${userId}', '${courseId}')"]`);
                if (tabButton) {
                    tabButton.disabled = true;
                    tabButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 등록 중...';
                }
                
                // 입력 값 검증
                if (!userId || !courseId) {
                    console.error('❌ 탭에서 필수 파라미터 누락:', { userId, courseId });
                    showToast('사용자 ID 또는 강좌 ID가 없습니다.', 'error');
                    
                    // 버튼 상태 복원
                    if (tabButton) {
                        tabButton.disabled = false;
                        tabButton.innerHTML = '<i class="fas fa-plus"></i>';
                    }
                    return;
                }

                // 🔥 Supabase 연결 확인
                if (!supabase) {
                    console.error('❌ 탭에서 Supabase 연결이 없습니다!');
                    showToast('데이터베이스 연결 오류입니다. 페이지를 새로고침해 주세요.', 'error');
                    
                    // 버튼 상태 복원
                    if (tabButton) {
                        tabButton.disabled = false;
                        tabButton.innerHTML = '<i class="fas fa-plus"></i>';
                    }
                    return;
                }

                // 이미 등록되어 있는지 확인
                console.log('🔄 탭에서 기존 등록 여부 확인 중...');
                const { data: existingEnrollment, error: checkError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('course_id', courseId)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('❌ 탭에서 등록 여부 확인 에러:', checkError);
                    throw new Error('등록 여부 확인 실패: ' + checkError.message);
                }

                if (existingEnrollment) {
                    console.log('⚠️ 탭에서 이미 등록된 사용자');
                    showToast('이미 등록된 수강자입니다.', 'warning');
                    return;
                }

                console.log('🔄 탭에서 수강자 등록 시작...');

                // 1. enrollments 테이블에 등록 정보 삽입
                const enrollmentData = {
                    user_id: userId,
                    course_id: courseId,
                    status: 'enrolled',
                    progress: 0,
                    enrolled_at: new Date().toISOString()
                };

                console.log('📝 탭 등록 데이터:', enrollmentData);

                const { data: enrollResult, error: enrollError } = await supabase
                    .from('enrollments')
                    .insert([enrollmentData])
                    .select('*');

                if (enrollError) {
                    console.error('❌ 탭에서 enrollments 테이블 삽입 에러:', enrollError);
                    throw new Error('등록 실패: ' + enrollError.message);
                }

                console.log('✅ 탭에서 enrollments 테이블에 등록 완료:', enrollResult);

                // 2. 영상 접근 권한 부여 (간단한 방식)
                try {
                    console.log('🔄 탭에서 접근 권한 부여 중...');
                    
                    // enrollments 테이블에 성공적으로 등록되었으므로 접근 권한도 부여된 것으로 간주
                    console.log('✅ 탭에서 접근 권한 부여 완료 (enrollments 등록으로 자동 부여)');

                    // 3. 강좌 정보 확인
                    const { data: course, error: courseError } = await supabase
                        .from('courses')
                        .select('title, video_url')
                        .eq('id', courseId)
                        .single();

                    if (course) {
                        console.log('📚 탭에서 등록된 강좌:', course.title);
                        if (course.video_url) {
                            console.log('📹 영상 URL:', course.video_url);
                        }
                    }

                } catch (accessError) {
                    console.warn('⚠️ 탭에서 접근 권한 부여 중 경고:', accessError);
                    // 접근 권한 부여 실패해도 등록은 완료된 상태이므로 계속 진행
                }

                // 4. 성공 메시지 표시
                console.log('🎉 탭에서 등록 완료!');
                showToast('✅ 수강자가 성공적으로 등록되었습니다! 이제 해당 강좌 영상을 시청할 수 있습니다.', 'success');
                
                // 5. 수강자 목록 새로고침
                console.log('🔄 탭에서 수강자 목록 새로고침 중...');
                await loadStudentsForCourseInTab(courseId);
                await updateStudentCount(courseId);

                // 🔥 탭 버튼 상태 복원 (성공 시)
                const tabSuccessButton = document.querySelector(`button[onclick="enrollStudentFromTab('${userId}', '${courseId}')"]`);
                if (tabSuccessButton) {
                    tabSuccessButton.disabled = false;
                    tabSuccessButton.innerHTML = '<i class="fas fa-check"></i> 완료';
                    
                    // 2초 후 원래 상태로 복원
                    setTimeout(() => {
                        if (tabSuccessButton) {
                            tabSuccessButton.innerHTML = '<i class="fas fa-plus"></i>';
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('❌ 탭에서 수강자 등록 전체 에러:', error);
                console.error('❌ 탭 에러 스택:', error.stack);
                showToast(`등록 중 오류가 발생했습니다: ${error.message}`, 'error');
                
                // 🔥 탭 버튼 상태 복원 (에러 시)
                const tabErrorButton = document.querySelector(`button[onclick="enrollStudentFromTab('${userId}', '${courseId}')"]`);
                if (tabErrorButton) {
                    tabErrorButton.disabled = false;
                    tabErrorButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 실패';
                    
                    // 3초 후 원래 상태로 복원
                    setTimeout(() => {
                        if (tabErrorButton) {
                            tabErrorButton.innerHTML = '<i class="fas fa-plus"></i>';
                        }
                    }, 3000);
                }
                
                // 에러 발생 시에도 목록 새로고침 시도
                try {
                    await loadStudentsForCourseInTab(courseId);
                    await updateStudentCount(courseId);
                } catch (refreshError) {
                    console.error('❌ 탭에서 목록 새로고침도 실패:', refreshError);
                }
            }
        }

        // 탭에서 개별 수강자 등록 해제
        async function unenrollStudentFromTab(userId, courseId) {
            try {
                if (!confirm('정말로 이 수강자의 등록을 해제하시겠습니까? 해당 강좌 영상 접근 권한도 함께 제거됩니다.')) {
                    return;
                }

                console.log('🔄 탭에서 수강자 등록 해제 중...', userId, courseId);

                // 1. enrollments 테이블에서 등록 정보 삭제
                const { error: deleteError } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('user_id', userId)
                    .eq('course_id', courseId);

                if (deleteError) {
                    throw new Error('등록 해제 실패: ' + deleteError.message);
                }

                // 2. 사용자 프로필에서 강좌 접근 권한 제거
                const { data: userProfile, error: profileError } = await supabase
                    .from('profiles')
                    .select('course_access')
                    .eq('id', userId)
                    .single();

                if (!profileError && userProfile) {
                    // 기존 접근 권한 목록에서 강좌 제거
                    const currentAccess = userProfile.course_access || [];
                    const updatedAccess = currentAccess.filter(id => id !== courseId);
                    
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ course_access: updatedAccess })
                        .eq('id', userId);

                    if (updateError) {
                        console.warn('탭에서 프로필 업데이트 실패:', updateError);
                    } else {
                        console.log('✅ 탭에서 사용자 프로필에서 강좌 접근 권한 제거됨');
                    }
                }

                // 3. user_course_access 테이블에서 접근 권한 제거
                const { error: accessError } = await supabase
                    .from('user_course_access')
                    .delete()
                    .eq('user_id', userId)
                    .eq('course_id', courseId);

                if (accessError) {
                    console.warn('탭에서 접근 권한 테이블에서 제거 실패:', accessError);
                } else {
                    console.log('✅ 탭에서 user_course_access 테이블에서 권한 제거됨');
                }

                // 4. 강좌 정보 확인
                const { data: course, error: courseError } = await supabase
                    .from('courses')
                    .select('title, video_url')
                    .eq('id', courseId)
                    .single();

                if (!courseError && course) {
                    console.log('✅ 탭에서 강좌 접근 권한 제거 완료:', course.title);
                    if (course.video_url) {
                        console.log('🚫 영상 URL 접근 권한 제거됨:', course.video_url);
                    }
                }

                showToast('수강자 등록이 해제되었습니다. 해당 강좌 영상 접근 권한도 제거되었습니다.', 'success');
                
                // 수강자 목록 새로고침
                await loadStudentsForCourseInTab(courseId);
                await updateStudentCount(courseId);

            } catch (error) {
                console.error('탭에서 수강자 등록 해제 에러:', error);
                showToast(`수강자 등록 해제 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 탭에서 모든 사용자 목록 새로고침
        async function loadAllUsersInTab() {
            const courseId = document.getElementById('course-id').value;
            if (courseId) {
                await loadStudentsForCourseInTab(courseId);
                showToast('사용자 목록이 새로고침되었습니다.', 'success');
            } else {
                showToast('강좌를 먼저 저장해야 합니다.', 'warning');
            }
        }

        // 수강생 수 업데이트
        async function updateStudentCount(courseId) {
            try {
                const { data: enrollments, error } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('course_id', courseId);

                const studentCount = enrollments ? enrollments.length : 0;
                document.getElementById('tab-course-students').textContent = `총 수강생: ${studentCount}명`;
            } catch (error) {
                console.error('수강생 수 업데이트 에러:', error);
            }
        }

        // ===============================
        // 전역 함수 노출 (window 객체에 등록)
        // ===============================
        
        // 즉시 전역으로 함수들 노출
        try {
            // 모든 함수를 전역으로 노출
            window.showAddCourseModal = showAddCourseModal;
            window.playVideo = playVideo;
            window.viewCourse = viewCourse;
            window.editCourse = editCourse;
            window.deleteCourse = deleteCourse;
            window.logoutUser = logoutUser;
            
            // 수강자 관리 함수들
            window.grantAllAccess = grantAllAccess;
            window.revokeAllAccess = revokeAllAccess;
            window.enrollStudent = enrollStudent;
            window.unenrollStudent = unenrollStudent;
            window.loadAllUsers = loadAllUsers;
            
            // 탭 내 수강자 관리 함수들
            window.grantAllAccessFromTab = grantAllAccessFromTab;
            window.revokeAllAccessFromTab = revokeAllAccessFromTab;
            window.enrollStudentFromTab = enrollStudentFromTab;
            window.unenrollStudentFromTab = unenrollStudentFromTab;
            window.loadAllUsersInTab = loadAllUsersInTab;
            
            // 테스트 함수 추가
            function testEnrollment() {
                console.log('🧪 테스트 함수 실행됨!');
                const testUserId = 'd409eb0c-f155-4dbc-8f5e-e37e99df047f';
                const testCourseId = document.getElementById('course-id')?.value || 'test-course';
                
                console.log('🧪 테스트 등록 시도:', testUserId, testCourseId);
                
                // 직접 함수 호출
                enrollStudentFromTab(testUserId, testCourseId);
            }
            
            window.testEnrollment = testEnrollment;
            
            // 디버그 함수 추가
            function debugModal() {
                console.log('🔧 디버그: 모달 강제 열기 시도');
                try {
                    $('#course-modal').modal('show');
                    console.log('✅ 모달 열기 성공');
                } catch (error) {
                    console.error('❌ 모달 열기 실패:', error);
                }
            }
            
            function debugTest() {
                console.log('🔧 디버그 정보:');
                console.log('- showAddCourseModal 함수:', typeof window.showAddCourseModal);
                console.log('- jQuery 로드:', typeof window.$);
                console.log('- Bootstrap 모달:', typeof $.fn.modal);
                console.log('- Supabase 클라이언트:', !!supabase);
                console.log('- 현재 사용자:', currentUser);
            }
            
            window.debugModal = debugModal;
            window.debugTest = debugTest;
            
            console.log('✅ 모든 스크립트 로드 완료');
            console.log('💡 디버깅 명령어: debugTest(), debugModal(), showAddCourseModal()');
        } catch (error) {
            console.error('❌ 전역 함수 노출 에러:', error);
        }
    </script>
</body>
</html> 