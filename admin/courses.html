<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>강좌 관리 - 바로교육 관리자</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Korean Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .content-wrapper {
            background: #f4f4f4;
        }
        .card {
            box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
            border-radius: .25rem;
        }
        .brand-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-dark-primary .nav-sidebar > .nav-item > .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .course-thumbnail {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-published {
            background: #d4edda;
            color: #155724;
        }
        .status-draft {
            background: #f8d7da;
            color: #721c24;
        }
        .course-price {
            font-weight: 600;
            color: #007bff;
        }
        .course-rating {
            color: #ffc107;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <!-- 네비게이션 바 -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- 왼쪽 네비게이션 -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                        <i class="fas fa-bars"></i>
                    </a>
                </li>
            </ul>

            <!-- 오른쪽 네비게이션 -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="far fa-user"></i>
                        <span class="ml-1" id="admin-name">관리자</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user mr-2"></i> 프로필
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt mr-2"></i> 로그아웃
                        </a>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- 메인 사이드바 -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- 브랜드 로고 -->
            <a href="index.html" class="brand-link">
                <img src="../images/logo.png" alt="바로교육" class="brand-image img-circle elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">바로교육 관리자</span>
            </a>

            <!-- 사이드바 -->
            <div class="sidebar">
                <!-- 사이드바 메뉴 -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>대시보드</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="users.html" class="nav-link">
                                <i class="nav-icon fas fa-users"></i>
                                <p>사용자 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="courses.html" class="nav-link active">
                                <i class="nav-icon fas fa-book"></i>
                                <p>강좌 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="reviews.html" class="nav-link">
                                <i class="nav-icon fas fa-star"></i>
                                <p>후기 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="payments.html" class="nav-link">
                                <i class="nav-icon fas fa-credit-card"></i>
                                <p>결제 관리</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="statistics.html" class="nav-link">
                                <i class="nav-icon fas fa-chart-pie"></i>
                                <p>통계</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="settings.html" class="nav-link">
                                <i class="nav-icon fas fa-cogs"></i>
                                <p>설정</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- 콘텐츠 래퍼 -->
        <div class="content-wrapper">
            <!-- 콘텐츠 헤더 -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">강좌 관리</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="index.html">홈</a></li>
                                <li class="breadcrumb-item active">강좌 관리</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 콘텐츠 -->
            <section class="content">
                <div class="container-fluid">
                    <!-- 강좌 목록 카드 -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">강좌 목록</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
                                    <i class="fas fa-plus"></i> 새 강좌 추가
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="courses-table" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>썸네일</th>
                                            <th>제목</th>
                                            <th>강사</th>
                                            <th>카테고리</th>
                                            <th>가격</th>
                                            <th>평점</th>
                                            <th>수강생</th>
                                            <th>상태</th>
                                            <th>생성일</th>
                                            <th>작업</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 동적으로 로드됨 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 푸터 -->
        <footer class="main-footer">
            <strong>Copyright &copy; 2024 바로교육.</strong>
            All rights reserved.
            <div class="float-right d-none d-sm-inline-block">
                <b>Version</b> 1.0.0
            </div>
        </footer>
    </div>

    <!-- 강좌 추가/수정 모달 -->
    <div class="modal fade" id="course-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-title">강좌 추가</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="course-form">
                    <div class="modal-body">
                        <input type="hidden" id="course-id">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="course-title">강좌 제목 *</label>
                                    <input type="text" class="form-control" id="course-title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="course-status">상태</label>
                                    <select class="form-control" id="course-status">
                                        <option value="draft">임시저장</option>
                                        <option value="published">게시</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="course-instructor">강사명 *</label>
                                    <input type="text" class="form-control" id="course-instructor" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="course-category">카테고리</label>
                                    <select class="form-control" id="course-category">
                                        <option value="marketing">마케팅</option>
                                        <option value="branding">브랜드</option>
                                        <option value="development">창업</option>
                                        <option value="crm">CRM</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="course-price">가격 (원)</label>
                                    <input type="number" class="form-control" id="course-price" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="course-duration">수강시간 (시간)</label>
                                    <input type="number" class="form-control" id="course-duration" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="course-difficulty">난이도</label>
                                    <select class="form-control" id="course-difficulty">
                                        <option value="beginner">초급</option>
                                        <option value="intermediate">중급</option>
                                        <option value="advanced">고급</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="course-short-description">짧은 설명</label>
                            <input type="text" class="form-control" id="course-short-description" maxlength="100">
                        </div>

                        <div class="form-group">
                            <label for="course-description">상세 설명</label>
                            <textarea class="form-control" id="course-description" rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="course-thumbnail">썸네일 URL</label>
                            <input type="url" class="form-control" id="course-thumbnail">
                        </div>

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="course-is-free">
                            <label class="form-check-label" for="course-is-free">
                                무료 강좌
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 설정 -->
    <script src="js/supabase-config.js"></script>
    <!-- API 클라이언트 -->
    <script src="js/api-client.js"></script>
    
    <script>
        let coursesTable = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 인증 확인
                const user = await checkAuth();
                
                if (user) {
                    // 사용자 정보 업데이트
                    document.getElementById('admin-name').textContent = user.name || user.email || '관리자';
                    
                    // 강좌 관리 페이지 초기화
                    await initCoursesPage();
                    
                    console.log('✅ 강좌 관리 페이지 초기화 완료');
                } else {
                    // 인증 실패 시 로그인 페이지로 이동
                    window.location.href = 'login.html';
                }
                
            } catch (error) {
                console.error('❌ 페이지 초기화 에러:', error);
                window.location.href = 'login.html';
            }
        });

        // 강좌 관리 페이지 초기화
        async function initCoursesPage() {
            try {
                // 강좌 테이블 초기화
                await initCoursesTable();
                
                // 강좌 목록 로드
                await loadCourses();
                
                console.log('✅ 강좌 관리 페이지 로드 완료');
            } catch (error) {
                console.error('❌ 강좌 관리 페이지 초기화 에러:', error);
                showToast('강좌 데이터를 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 강좌 테이블 초기화
        async function initCoursesTable() {
            try {
                if (coursesTable) {
                    coursesTable.destroy();
                }

                coursesTable = $('#courses-table').DataTable({
                    responsive: true,
                    language: {
                        "search": "검색:",
                        "lengthMenu": "_MENU_ 개씩 보기",
                        "info": "_START_에서 _END_까지 (총 _TOTAL_개)",
                        "paginate": {
                            "first": "처음",
                            "last": "마지막",
                            "next": "다음",
                            "previous": "이전"
                        },
                        "emptyTable": "강좌 데이터가 없습니다.",
                        "zeroRecords": "검색 결과가 없습니다."
                    },
                    pageLength: 25,
                    order: [[8, 'desc']], // 생성일 기준 내림차순
                    columnDefs: [
                        { targets: [0, 9], orderable: false }, // 썸네일, 작업 컬럼 정렬 비활성화
                        { targets: [4], className: 'text-right' }, // 가격 컬럼 우측 정렬
                        { targets: [5, 6], className: 'text-center' }, // 평점, 수강생 컬럼 중앙 정렬
                        { targets: [8], type: 'date' } // 생성일 컬럼
                    ]
                });
                
                console.log('✅ 강좌 테이블 초기화 완료');
            } catch (error) {
                console.error('강좌 테이블 초기화 에러:', error);
            }
        }

        // 강좌 목록 로드
        async function loadCourses() {
            try {
                console.log('🔄 강좌 목록 로드 중...');
                
                // Supabase에서 강좌 목록 가져오기
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('강좌 목록 조회 에러:', error);
                    // 에러 시 샘플 데이터 표시
                    displaySampleCourses();
                    return;
                }

                if (coursesTable) {
                    coursesTable.clear();
                    
                    if (courses && courses.length > 0) {
                        courses.forEach(course => {
                            const row = createCourseRow(course);
                            coursesTable.row.add(row);
                        });
                    }
                    
                    coursesTable.draw();
                }
                
                console.log(`✅ 강좌 ${courses?.length || 0}개 로드 완료`);
            } catch (error) {
                console.error('강좌 목록 로드 에러:', error);
                displaySampleCourses();
            }
        }

        // 실제 강좌 데이터 표시 (바로교육 사이트 기반)
        function displaySampleCourses() {
            if (!coursesTable) return;

            const realCourses = [
                {
                    id: '1',
                    title: 'SNS 마케팅 마스터',
                    instructor: '김마케팅',
                    category: 'marketing',
                    price: 99000,
                    rating: 4.8,
                    students: 150,
                    status: 'published',
                    thumbnail: '../images/pd1.jpg',
                    created_at: '2024-01-15T10:30:00Z'
                },
                {
                    id: '2',
                    title: 'AI 상세페이지 최적화',
                    instructor: '이디자인',
                    category: 'branding',
                    price: 0,
                    rating: 4.5,
                    students: 89,
                    status: 'published',
                    thumbnail: '../images/pd2.jpg',
                    created_at: '2024-01-10T15:45:00Z'
                },
                {
                    id: '3',
                    title: '바이럴 콘텐츠 기초부터 실전',
                    instructor: '박바이럴',
                    category: 'marketing',
                    price: 149000,
                    rating: 4.9,
                    students: 203,
                    status: 'published',
                    thumbnail: '../images/pd3.jpg',
                    created_at: '2024-01-08T11:20:00Z'
                },
                {
                    id: '4',
                    title: '쇼핑몰 창업 A to Z',
                    instructor: '최창업',
                    category: 'development',
                    price: 199000,
                    rating: 4.7,
                    students: 132,
                    status: 'published',
                    thumbnail: '../images/pd4.jpg',
                    created_at: '2024-01-05T14:20:00Z'
                },
                {
                    id: '5',
                    title: '고객 관리 시스템 구축',
                    instructor: '정시스템',
                    category: 'crm',
                    price: 129000,
                    rating: 4.6,
                    students: 78,
                    status: 'published',
                    thumbnail: '../images/pd11.jpg',
                    created_at: '2024-01-03T09:15:00Z'
                },
                {
                    id: '6',
                    title: '브랜딩 전략 수립',
                    instructor: '김브랜드',
                    category: 'branding',
                    price: 179000,
                    rating: 4.8,
                    students: 95,
                    status: 'published',
                    thumbnail: '../images/pd12.jpg',
                    created_at: '2024-01-02T16:30:00Z'
                },
                {
                    id: '7',
                    title: '온라인 마케팅 전략',
                    instructor: '이온라인',
                    category: 'marketing',
                    price: 0,
                    rating: 4.4,
                    students: 234,
                    status: 'published',
                    thumbnail: '../images/pd13.jpg',
                    created_at: '2024-01-01T11:45:00Z'
                },
                {
                    id: '8',
                    title: '스타트업 사업계획서 작성',
                    instructor: '박사업',
                    category: 'development',
                    price: 89000,
                    rating: 4.5,
                    students: 67,
                    status: 'draft',
                    thumbnail: '../images/pd14.jpg',
                    created_at: '2023-12-30T13:20:00Z'
                },
                {
                    id: '9',
                    title: '소셜미디어 운영 전략',
                    instructor: '최소셜',
                    category: 'marketing',
                    price: 119000,
                    rating: 4.7,
                    students: 156,
                    status: 'published',
                    thumbnail: '../images/portfolio2.jpg',
                    created_at: '2023-12-28T10:10:00Z'
                },
                {
                    id: '10',
                    title: '웹디자인 기초',
                    instructor: '김웹디',
                    category: 'branding',
                    price: 79000,
                    rating: 4.3,
                    students: 112,
                    status: 'published',
                    thumbnail: '../images/webdesign.png',
                    created_at: '2023-12-25T15:30:00Z'
                }
            ];

            coursesTable.clear();
            realCourses.forEach(course => {
                const row = createCourseRow(course);
                coursesTable.row.add(row);
            });
            coursesTable.draw();

            showToast('실제 바로교육 강좌 데이터를 표시합니다.', 'success');
        }

        // 강좌 행 생성
        function createCourseRow(course) {
            const thumbnail = course.thumbnail ? 
                `<img src="${course.thumbnail}" alt="썸네일" class="course-thumbnail">` : 
                `<div class="course-thumbnail bg-secondary d-flex align-items-center justify-content-center">
                    <i class="fas fa-book text-white"></i>
                </div>`;
            
            const title = course.title || '제목 없음';
            const instructor = course.instructor || '강사 미정';
            const category = getCategoryName(course.category);
            const price = course.price > 0 ? 
                `<span class="course-price">${Number(course.price).toLocaleString()}원</span>` : 
                '<span class="badge badge-success">무료</span>';
            
            const rating = course.rating ? 
                `<span class="course-rating">
                    <i class="fas fa-star"></i> ${course.rating}
                </span>` : 
                '<span class="text-muted">평가 없음</span>';
            
            const students = course.students || 0;
            
            const status = course.status === 'published' ? 
                '<span class="badge badge-success">게시</span>' : 
                '<span class="badge badge-warning">임시저장</span>';
            
            const createdAt = course.created_at ? db.formatDate(course.created_at) : '날짜 없음';
            
            const actions = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewCourse('${course.id}')" title="상세보기">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-warning" onclick="editCourse('${course.id}')" title="수정">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteCourse('${course.id}')" title="삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return [thumbnail, title, instructor, category, price, rating, students, status, createdAt, actions];
        }

        // 카테고리 이름 변환
        function getCategoryName(category) {
            const categories = {
                'marketing': '마케팅',
                'branding': '브랜드',
                'development': '창업',
                'crm': 'CRM'
            };
            return categories[category] || category || '기타';
        }

        // 새 강좌 추가 모달 표시
        function showAddCourseModal() {
            document.getElementById('modal-title').textContent = '새 강좌 추가';
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            $('#course-modal').modal('show');
        }

        // 강좌 상세보기
        function viewCourse(courseId) {
            showToast('강좌 상세보기 기능은 준비 중입니다.', 'info');
        }

        // 강좌 수정
        function editCourse(courseId) {
            showToast('강좌 수정 기능은 준비 중입니다.', 'info');
        }

        // 강좌 삭제
        function deleteCourse(courseId) {
            if (confirm('정말로 이 강좌를 삭제하시겠습니까?')) {
                showToast('강좌 삭제 기능은 준비 중입니다.', 'info');
            }
        }

        // 강좌 폼 제출
        document.getElementById('course-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const courseData = {
                    title: document.getElementById('course-title').value,
                    instructor: document.getElementById('course-instructor').value,
                    category: document.getElementById('course-category').value,
                    price: parseInt(document.getElementById('course-price').value) || 0,
                    duration: parseInt(document.getElementById('course-duration').value) || 0,
                    difficulty: document.getElementById('course-difficulty').value,
                    short_description: document.getElementById('course-short-description').value,
                    description: document.getElementById('course-description').value,
                    thumbnail: document.getElementById('course-thumbnail').value,
                    status: document.getElementById('course-status').value,
                    is_free: document.getElementById('course-is-free').checked
                };

                const courseId = document.getElementById('course-id').value;
                
                if (courseId) {
                    // 수정 로직
                    showToast('강좌 수정 기능은 준비 중입니다.', 'info');
                } else {
                    // 추가 로직
                    showToast('강좌 추가 기능은 준비 중입니다.', 'info');
                }
                
                $('#course-modal').modal('hide');
                
            } catch (error) {
                console.error('강좌 저장 에러:', error);
                showToast('강좌 저장 중 오류가 발생했습니다.', 'error');
            }
        });

        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const existingToast = document.getElementById('courses-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'courses-toast';
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                    <button type="button" class="close ml-auto" onclick="this.parentElement.parentElement.remove()">
                        <span>&times;</span>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html> 